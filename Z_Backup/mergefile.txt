==================== FILE: database/migrations/2025_12_06_102959_create_exams_table.php ====================
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('exams', function (Blueprint $table) {
            $table->engine = 'InnoDB';

            $table->id();
            $table->uuid('uuid')->unique();

            $table->foreignId('user_id')
                ->constrained('users')
                ->cascadeOnDelete();

            $table->foreignId('teacher_id')
                ->constrained('users')
                ->cascadeOnDelete();

            $table->foreignId('classroom_id')->nullable()
                ->constrained('classrooms')
                ->nullOnDelete();

            $table->enum('exam_type', ['public','class_single','class_comprehensive'])
                ->default('public');

            $table->string('title', 250);
            $table->text('description')->nullable();

            $table->unsignedSmallInteger('duration_minutes');

            $table->foreignId('section_id')->constrained('sections')->restrictOnDelete();
            $table->foreignId('grade_id')->constrained('grades')->restrictOnDelete();
            $table->foreignId('branch_id')->constrained('branches')->restrictOnDelete();
            $table->foreignId('field_id')->constrained('fields')->restrictOnDelete();
            $table->foreignId('subfield_id')->nullable()->constrained('subfields')->nullOnDelete();
            $table->foreignId('subject_type_id')->nullable()->constrained('subject_types')->nullOnDelete();

            $table->unsignedSmallInteger('total_questions')->nullable();
            $table->longText('coefficients')->nullable();

            $table->dateTime('start_at')->nullable();
            $table->dateTime('end_at')->nullable();

            $table->boolean('shuffle_questions')->default(false);
            $table->boolean('shuffle_options')->default(false);
            $table->boolean('ai_assisted')->default(false);

            // FK ÿ®ÿπÿØÿßŸã ÿØÿ± add_ ŸÜŸáÿß€å€å
            $table->unsignedBigInteger('ai_session_id')->nullable();

            $table->boolean('is_active')->default(true);
            $table->boolean('is_published')->default(false);

            $table->timestamps();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('exams');
    }
};


==================== FILE: database/migrations/2025_12_11_185939_add_exam_mode_to_exams_table.php ====================
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up()
    {
        Schema::table('exams', function (Blueprint $table) {
            $table->string('exam_mode')
                  ->default('single_subject')
                  ->after('exam_type');

            // ÿØÿ±ÿ≥ ÿßÿµŸÑ€å ÿßŸÖÿ™ÿ≠ÿßŸÜ ÿ™⁄©‚ÄåÿØÿ±ÿ≥
            $table->unsignedBigInteger('primary_subject_id')
                  ->nullable()
                  ->after('subject_type_id');

            // ÿß⁄Øÿ± ŸÑÿßÿ≤ŸÖ ÿ¥ÿØ ÿßÿ≤ ÿ±ÿßÿ®ÿ∑Ÿá ÿßÿ≥ÿ™ŸÅÿßÿØŸá ŸÖ€å‚Äå⁄©ŸÜ€åŸÖ
            $table->foreign('primary_subject_id')
                  ->references('id')->on('subjects')
                  ->nullOnDelete();
        });
    }

    public function down()
    {
        Schema::table('exams', function (Blueprint $table) {
            $table->dropForeign(['primary_subject_id']);
            $table->dropColumn(['exam_mode', 'primary_subject_id']);
        });
    }
};


==================== FILE: database/migrations/2025_12_06_103002_create_exam_subject_table.php ====================
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('exam_subject', function (Blueprint $table) {
            $table->engine = 'InnoDB';

            $table->foreignId('exam_id')
                ->constrained('exams')
                ->cascadeOnDelete();

            $table->foreignId('subject_id')
                ->constrained('subjects')
                ->cascadeOnDelete();

            $table->unsignedSmallInteger('question_count')->nullable();

            $table->primary(['exam_id', 'subject_id']);
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('exam_subject');
    }
};


==================== FILE: database/migrations/2025_12_06_103120_create_exam_questions_table.php ====================
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('exam_questions', function (Blueprint $table) {
            $table->engine = 'InnoDB';

            $table->foreignId('exam_id')
                ->constrained('exams')
                ->cascadeOnDelete();

            $table->foreignId('question_id')
                ->constrained('questions')
                ->cascadeOnDelete();

            $table->unsignedInteger('sort_order')->default(0);

            $table->primary(['exam_id', 'question_id']);
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('exam_questions');
    }
};


==================== FILE: app/Models/Exam.php ====================
<?php
// app/Models/Exam.php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Relations\BelongsToMany;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Illuminate\Support\Str;

class Exam extends Model
{
    use HasFactory;

    protected $table = 'exams';

    // id ÿß€åŸÜ⁄©ÿ±€åŸÖŸÜÿ™ ÿßÿ≥ÿ™ (INT) ‚Üí ÿ™ŸÜÿ∏€åŸÖ Ÿæ€åÿ¥‚ÄåŸÅÿ±ÿ∂ ŸÑÿßÿ±ÿßŸàŸÑ ⁄©ÿßŸÅ€å ÿßÿ≥ÿ™

    protected $fillable = [
        'user_id',
        'teacher_id',
        'classroom_id',

        'exam_type',

        // ÿ®ÿ±ÿß€å ŸÅÿ±ŸÖ ÿ≥ÿßÿØŸá Ÿà€åÿ±ÿß€åÿ¥
        'scope',       // classroom / free
        'subject',     // ÿ®ÿ±⁄Üÿ≥ÿ® ŸÜŸÖÿß€åÿ¥€å ÿØÿ±ÿ≥ (ŸÖÿ´ŸÑÿßŸã ÿπŸÜŸàÿßŸÜ ŸÅÿßÿ±ÿ≥€å)
        'level',       // taghviyati / konkur / olympiad

        'title',
        'description',
        'duration_minutes',

        'section_id',
        'grade_id',
        'branch_id',
        'field_id',
        'subfield_id',
        'subject_type_id',

        'total_questions',
        'coefficients',

        'start_at',
        'end_at',

        'shuffle_questions',
        'shuffle_options',
        'ai_assisted',
        'ai_session_id',

        'is_active',
        'is_published',

        'uuid',
    ];

    protected $casts = [
        'duration_minutes'  => 'integer',
        'total_questions'   => 'integer',

        'coefficients'      => 'array',

        'shuffle_questions' => 'boolean',
        'shuffle_options'   => 'boolean',
        'ai_assisted'       => 'boolean',

        'is_active'         => 'boolean',
        'is_published'      => 'boolean',

        'start_at'          => 'datetime',
        'end_at'            => 'datetime',
        'created_at'        => 'datetime',
        'updated_at'        => 'datetime',
    ];

    // ================== ÿ±Ÿàÿßÿ®ÿ∑ ==================

    public function teacher(): BelongsTo
    {
        return $this->belongsTo(User::class, 'teacher_id');
    }

    public function user(): BelongsTo
    {
        return $this->belongsTo(User::class, 'user_id');
    }

    public function classroom(): BelongsTo
    {
        return $this->belongsTo(Classroom::class, 'classroom_id');
    }

    public function questions(): BelongsToMany
    {
        return $this->belongsToMany(
            Question::class,
            'exam_questions',
            'exam_id',
            'question_id'
        )->withPivot('sort_order');
    }

    public function attempts(): HasMany
    {
        return $this->hasMany(ExamAttempt::class, 'exam_id');
    }

    public function subjects(): BelongsToMany
    {
        return $this->belongsToMany(
            Subject::class,
            'exam_subject',
            'exam_id',
            'subject_id'
        )->withPivot('question_count');
    }

    public function section(): BelongsTo
    {
        return $this->belongsTo(Section::class, 'section_id');
    }

    public function grade(): BelongsTo
    {
        return $this->belongsTo(Grade::class, 'grade_id');
    }

    public function branch(): BelongsTo
    {
        return $this->belongsTo(Branch::class, 'branch_id');
    }

    public function field(): BelongsTo
    {
        return $this->belongsTo(Field::class, 'field_id');
    }

    public function subfield(): BelongsTo
    {
        return $this->belongsTo(Subfield::class, 'subfield_id');
    }

    public function subjectType(): BelongsTo
    {
        return $this->belongsTo(SubjectType::class, 'subject_type_id');
    }

    public function aiSession(): BelongsTo
    {
        return $this->belongsTo(AiSession::class, 'ai_session_id');
    }

    public function getRouteKeyName()
    {
        return 'id';
    }

    // ================== UUID ==================

    protected static function booted()
    {
        static::creating(function ($exam) {
            if (empty($exam->uuid)) {
                $exam->uuid = (string) Str::uuid();
            }
        });
    }



}


==================== FILE: app/Models/Classroom.php ====================
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Relations\BelongsToMany;
use Illuminate\Database\Eloquent\Relations\HasMany;
use Illuminate\Support\Str;

class Classroom extends Model
{
    use HasFactory;

    protected $table = "classrooms";

    // ‚úÖ id ÿß€åŸÜ⁄©ÿ±€åŸÖŸÜÿ™ ÿßÿ≥ÿ™ ‚Üí ÿ≠ÿßŸÑÿ™ Ÿæ€åÿ¥‚ÄåŸÅÿ±ÿ∂ ŸÑÿßÿ±ÿßŸàŸÑ

    protected $fillable = [
        "uuid",
        "teacher_id",
        "title",
        "description",

        "section_id",
        "grade_id",
        "branch_id",
        "field_id",
        "subfield_id",
        "subject_type_id",
        "subject_id",

        "classroom_type",
        "join_code",
        "is_active",
        "metadata",
    ];

    protected $casts = [
        "is_active" => "boolean",
        "metadata"  => "array",
        "created_at" => "datetime",
        "updated_at" => "datetime",
    ];

    // ==========================================================
    // Relationships
    // ==========================================================

    /** Teacher who owns the classroom */
    public function teacher(): BelongsTo
    {
        return $this->belongsTo(User::class, "teacher_id");
    }

    /**
     * All classroom members (students + teachers)
     * pivot: classroom_user(classroom_id, user_id)
     */
    public function users(): BelongsToMany
    {
        return $this->belongsToMany(
            User::class,
            "classroom_user",
            "classroom_id",
            "user_id"
        );
    }

    /** Backward-compatible alias */
    public function members(): BelongsToMany
    {
        return $this->users();
    }

    /**
     * Classroom students
     * pivot classroom_user has no role column
     * so we filter through roles relation on User.
     */
    public function students(): BelongsToMany
    {
        return $this->users()
            ->whereHas("roles", fn ($q) => $q->where("slug", "student"));
    }

    /** Classroom teachers (future multi-teacher support) */
    public function teachers(): BelongsToMany
    {
        return $this->users()
            ->whereHas("roles", fn ($q) => $q->where("slug", "teacher"));
    }

    /** Exams belonging to this classroom */
    public function exams(): HasMany
    {
        return $this->hasMany(Exam::class, "classroom_id");
    }

    /**
     * Subjects attached to this classroom
     * pivot: classroom_subject(classroom_id, subject_id)
     */
    public function subjects(): BelongsToMany
    {
        return $this->belongsToMany(
            Subject::class,
            "classroom_subject",
            "classroom_id",
            "subject_id"
        );
    }

    // --- Taxonomy relations ---

    public function section(): BelongsTo
    {
        return $this->belongsTo(Section::class, "section_id");
    }

    public function grade(): BelongsTo
    {
        return $this->belongsTo(Grade::class, "grade_id");
    }

    public function branch(): BelongsTo
    {
        return $this->belongsTo(Branch::class, "branch_id");
    }

    public function field(): BelongsTo
    {
        return $this->belongsTo(Field::class, "field_id");
    }

    public function subfield(): BelongsTo
    {
        return $this->belongsTo(Subfield::class, "subfield_id");
    }

    public function subjectType(): BelongsTo
    {
        return $this->belongsTo(SubjectType::class, "subject_type_id");
    }

    public function subject(): BelongsTo
    {
        return $this->belongsTo(Subject::class, "subject_id");
    }

    // ==========================================================
    // Boot / Mutators
    // ==========================================================

    protected static function booted()
    {
        static::creating(function ($classroom) {

            // ‚úÖ uuid ÿßÿ¨ÿ®ÿßÿ±€å Ÿà unique
            if (empty($classroom->uuid)) {
                $classroom->uuid = (string) Str::uuid();
            }

            // ‚úÖ join_code unique
            if (empty($classroom->join_code)) {
                do {
                    $code = strtoupper(str()->random(6));
                } while (self::where("join_code", $code)->exists());

                $classroom->join_code = $code;
            }

            // ‚úÖ ÿß⁄Øÿ± ŸÜŸàÿπ ⁄©ŸÑÿßÿ≥ ŸÜŸÅÿ±ÿ≥ÿ™ÿßÿØ€åÿå Ÿæ€åÿ¥‚ÄåŸÅÿ±ÿ∂
            if (empty($classroom->classroom_type)) {
                $classroom->classroom_type = "single";
            }
        });
    }
}


==================== FILE: routes/teacher.php ====================
<?php

use Illuminate\Support\Facades\Route;

use App\Http\Controllers\Teacher\DashboardController;
use App\Http\Controllers\Teacher\TeacherClassController;
use App\Http\Controllers\Teacher\TeacherExamController;
use App\Http\Controllers\Teacher\TeacherStudentController;
use App\Http\Controllers\Teacher\SubjectController;
use App\Http\Controllers\Teacher\QuestionController;

Route::prefix('dashboard')
    ->middleware(['auth', 'role.selected'])
    ->group(function () {

        Route::prefix('teacher')
            ->name('teacher.')
            ->middleware('role:teacher')
            ->group(function () {

                Route::get('/', [DashboardController::class, 'index'])->name('index');

                // Classes
                Route::get('/classes', [TeacherClassController::class, 'index'])->name('classes.index');
                Route::resource('classes', TeacherClassController::class)
                    ->parameters(['classes' => 'class'])
                    ->except(['index']);

                Route::get('classes/{class}/students', [TeacherClassController::class, 'students'])->name('classes.students');
                Route::post('classes/{class}/students', [TeacherClassController::class, 'addStudent'])->name('classes.students.add');
                Route::delete('classes/{class}/students/{student}', [TeacherClassController::class, 'removeStudent'])->name('classes.students.remove');

                // Classes AJAX Data
                Route::prefix('classes/data')->name('classes.data.')->group(function () {
                    Route::get('/sections', [TeacherClassController::class, 'sections'])->name('sections');
                    Route::get('/grades/{section}', [TeacherClassController::class, 'grades'])->name('grades');
                    Route::get('/branches/{section}', [TeacherClassController::class, 'branches'])->name('branches');
                    Route::get('/fields/{branch}', [TeacherClassController::class, 'fields'])->name('fields');
                    Route::get('/subfields/{field}', [TeacherClassController::class, 'subfields'])->name('subfields');
                    Route::get('/subject-types', [TeacherClassController::class, 'subjectTypes'])->name('subject-types');
                    Route::get('/subjects', [TeacherClassController::class, 'subjects'])->name('subjects');
                });

                // Exams
                Route::resource('exams', TeacherExamController::class);

                Route::prefix('exams/data')->name('exams.data.')->group(function () {
                    Route::get('/sections', [TeacherExamController::class, 'sections'])->name('sections');
                    Route::get('/grades', [TeacherExamController::class, 'grades'])->name('grades');
                    Route::get('/branches', [TeacherExamController::class, 'branches'])->name('branches');
                    Route::get('/fields', [TeacherExamController::class, 'fields'])->name('fields');
                    Route::get('/subfields', [TeacherExamController::class, 'subfields'])->name('subfields');
                    Route::get('/subject-types', [TeacherExamController::class, 'subjectTypes'])->name('subject-types');
                    Route::get('/subjects', [TeacherExamController::class, 'subjects'])->name('subjects');
                });

                /*
                |----------------------------------------------------------------------
                | ‚úÖ Exam Questions (Wizard Only)
                |----------------------------------------------------------------------
                */
                Route::prefix('exams/{exam}')
                    ->name('exams.')
                    ->group(function () {

                        // index
                        Route::get('questions', [QuestionController::class, 'index'])
                            ->name('questions.index');

                        // Wizard UI
                        Route::get('questions/wizard/create', [QuestionController::class, 'create'])
                            ->name('questions.wizard.create');

                        Route::get('questions/wizard/{question}/edit', [QuestionController::class, 'edit'])
                            ->name('questions.wizard.edit');

                        // Store / Update
                        Route::post('questions', [QuestionController::class, 'store'])
                            ->name('questions.store');

                        Route::put('questions/{question}', [QuestionController::class, 'update'])
                            ->name('questions.update');

                        // Delete
                        Route::delete('questions/{question}', [QuestionController::class, 'destroy'])
                            ->name('questions.destroy');

                        // üîÅ Legacy routes ‚Üí Hard Redirect to Wizard (ÿ®ÿß name ÿ±ÿ≥ŸÖ€å)
                        Route::get('questions/create', function ($exam) {
                            return redirect()->route('teacher.exams.questions.wizard.create', $exam);
                        })->name('questions.create');

                        Route::get('questions/{question}/edit', function ($exam, $question) {
                            return redirect()->route('teacher.exams.questions.wizard.edit', [$exam, $question]);
                        })->name('questions.edit');
                    });

                // Students
                Route::get('/students', [TeacherStudentController::class, 'index'])->name('students.index');
                Route::get('/students/{student}', [TeacherStudentController::class, 'show'])->name('students.show');
                Route::get('/students/{student}/attempts', [TeacherStudentController::class, 'attempts'])->name('students.attempts');
                Route::get('/attempts/{attempt}', [TeacherStudentController::class, 'attemptShow'])->name('attempts.show');
                Route::post('/attempts/{attempt}/answers/{answer}/grade', [TeacherStudentController::class, 'gradeEssayAnswer'])
                    ->name('attempts.answers.grade');

                // Subjects
                Route::get('/subjects', [SubjectController::class, 'index'])->name('subjects.index');
                Route::post('/subjects', [SubjectController::class, 'store'])->name('subjects.store');

                // Static
                Route::view('/reports', 'dashboard.teacher.reports.index')->name('reports.index');
                Route::view('/profile', 'dashboard.teacher.profile')->name('profile');
            });
    });


==================== FILE: app/Http/Controllers/Teacher/TeacherExamController.php ====================
<?php
// app/Http/Controllers/Teacher/TeacherExamController.php

namespace App\Http\Controllers\Teacher;

use App\Http\Controllers\Controller;
use App\Models\Section;
use App\Models\Grade;
use App\Models\Branch;
use App\Models\Field;
use App\Models\Subfield;
use App\Models\SubjectType;
use App\Models\Subject;
use App\Models\Exam;
use App\Models\Classroom;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Str;

class TeacherExamController extends Controller
{
    // ==========================================================
    // Exams CRUD
    // ==========================================================

    public function index()
    {
        $teacherId = Auth::id();

        $exams = Exam::query()
            ->where('teacher_id', $teacherId)
            ->latest()
            ->paginate(10);

        return view('dashboard.teacher.exams.index', compact('exams'));
    }

    public function create(Request $request)
    {
        $selectedClassroomId = $request->get('classroom_id');
        return view('dashboard.teacher.exams.create', compact('selectedClassroomId'));
    }

    public function store(Request $request)
    {
        $validated = $request->validate([
            'exam_type'        => 'required|string',
            'title'            => 'required|string|max:255',
            'description'      => 'nullable|string',
            'duration'         => 'required|integer|min:5|max:300',
            'classroom_id'     => 'nullable|exists:classrooms,id',

            // Taxonomy
            'section_id'       => 'required|integer',
            'grade_id'         => 'required|integer',
            'branch_id'        => 'required|integer',
            'field_id'         => 'required|integer',
            'subfield_id'      => 'required|integer',
            'subject_type_id'  => 'required|integer',

            // Step7
            'subjects'         => 'required|string',  // JSON string
        ]);

        // ---------------------------
        // 1) ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ subjects
        // ---------------------------
        $subjects = json_decode($validated['subjects'], true) ?? [];

        if (!is_array($subjects) || count($subjects) === 0) {
            return back()->withErrors(['subjects' => 'ÿ≠ÿØÿßŸÇŸÑ €å⁄© ÿØÿ±ÿ≥ ÿ®ÿß€åÿØ ÿßŸÜÿ™ÿÆÿßÿ® ÿ¥ŸàÿØ.'])->withInput();
        }

        // ---------------------------
        // 2) ÿ™ÿπ€å€åŸÜ exam_mode
        // ---------------------------
        $examMode = $this->detectExamMode($validated['exam_type']);

        // ---------------------------
        // 3) ÿ™ÿπ€å€åŸÜ ÿØÿ±ÿ≥ ÿßÿµŸÑ€å ÿØÿ± ÿ≠ÿßŸÑÿ™ ÿ™⁄©‚ÄåÿØÿ±ÿ≥
        // ---------------------------
        $primarySubjectId = ($examMode === 'single_subject')
            ? $subjects[0]
            : null;

        // ---------------------------
        // 4) ÿ≥ÿßÿÆÿ™ ÿ±⁄©Ÿàÿ±ÿØ exam
        // ---------------------------
        $exam = Exam::create([
            'user_id'          => auth()->id(),
            'teacher_id'       => auth()->id(),
            'classroom_id'     => $validated['classroom_id'] ?? null,

            'exam_type'        => $validated['exam_type'],
            'exam_mode'        => $examMode,
            'primary_subject_id' => $primarySubjectId,

            'title'            => $validated['title'],
            'description'      => $validated['description'] ?? null,
            'duration_minutes' => $validated['duration'],

            'section_id'       => $validated['section_id'],
            'grade_id'         => $validated['grade_id'],
            'branch_id'        => $validated['branch_id'],
            'field_id'         => $validated['field_id'],
            'subfield_id'      => $validated['subfield_id'],
            'subject_type_id'  => $validated['subject_type_id'],

            'is_active'        => $request->boolean('is_active', true),
        ]);

        // ---------------------------
        // 5) ÿßÿ™ÿµÿßŸÑ subjects ÿ®Ÿá pivot
        // ---------------------------
        if ($examMode === 'multi_subject') {
            $exam->subjects()->sync($subjects);
        } else {
            // single_subject ‚Üí ŸÅŸÇÿ∑ 1 ÿØÿ±ÿ≥
            $exam->subjects()->sync([$primarySubjectId]);
        }

        return redirect()
            ->route('teacher.exams.index')
            ->with('success', 'ÿ¢ÿ≤ŸÖŸàŸÜ ÿ®ÿß ŸÖŸàŸÅŸÇ€åÿ™ ÿß€åÿ¨ÿßÿØ ÿ¥ÿØ.');
    }


    public function show(Exam $exam)
    {
        abort_unless($exam->teacher_id === Auth::id(), 403);
        return view('dashboard.teacher.exams.show', compact('exam'));
    }

    public function edit(Exam $exam)
    {
        abort_unless($exam->teacher_id === Auth::id(), 403);

        // ⁄©ŸÑÿßÿ≥‚ÄåŸáÿß€å ŸáŸÖ€åŸÜ ŸÖÿπŸÑŸÖ ÿ®ÿ±ÿß€å ÿØÿ±ÿßŸæ‚ÄåÿØÿßŸÜ
        $classrooms = Classroom::query()
            ->where('teacher_id', Auth::id())
            ->orderBy('title')
            ->get();

        // ŸÑ€åÿ≥ÿ™ ÿØÿ±Ÿàÿ≥ ÿ®ÿ±ÿß€å ÿØÿ±ÿßŸæ‚ÄåÿØÿßŸÜ ÿ≥ÿßÿØŸá
        $subjects = Subject::where('is_active', 1)
            ->orderBy('title_fa')
            ->pluck('title_fa')
            ->toArray();

        return view('dashboard.teacher.exams.edit', compact('exam', 'classrooms', 'subjects'));
    }

    public function update(Request $request, Exam $exam)
    {
        $validated = $request->validate([
            'title'            => 'required|string|max:255',
            'description'      => 'nullable|string',
            'duration'         => 'required|integer|min:5|max:300',

            // Wizard ÿØÿ± Edit ŸÜÿØÿßÿ±€åŸÖ ‚Üí ÿßŸÖÿß ÿ®ÿ±ÿß€å ÿ≥ÿßÿ≤⁄Øÿßÿ±€å ÿ∞ÿÆ€åÿ±Ÿá ŸÖ€å‚Äå⁄©ŸÜ€åŸÖ
            'scope'            => 'required|string|in:free,classroom',
            'classroom_id'     => 'nullable|exists:classrooms,id',
            'subject'          => 'nullable|string',
            'level'            => 'nullable|string',
        ]);

        // ---------------------------
        // 1) update Ÿæÿß€åŸá
        // ---------------------------
        $exam->update([
            'title'            => $validated['title'],
            'description'      => $validated['description'] ?? null,
            'duration_minutes' => $validated['duration'],

            'scope'            => $validated['scope'],
            'classroom_id'     => $validated['scope'] === 'classroom'
                                    ? $validated['classroom_id']
                                    : null,

            'subject'          => $validated['subject'],
            'level'            => $validated['level'],

            'is_published'     => $request->boolean('is_published', false),
        ]);

        return redirect()
            ->route('teacher.exams.index')
            ->with('success', 'ÿ¢ÿ≤ŸÖŸàŸÜ ÿ®ÿß ŸÖŸàŸÅŸÇ€åÿ™ ÿ®ÿ±Ÿàÿ≤ÿ±ÿ≥ÿßŸÜ€å ÿ¥ÿØ.');
    }


    public function destroy(Exam $exam)
    {
        abort_unless($exam->teacher_id === Auth::id(), 403);
        $exam->delete();
        return back()->with('success', 'ÿ¢ÿ≤ŸÖŸàŸÜ ÿ≠ÿ∞ŸÅ ÿ¥ÿØ.');
    }

    // ==========================================================
    // AJAX Taxonomy Endpoints
    // ==========================================================

    public function sections()
    {
        $sections = Section::where('is_active', 1)
            ->orderBy('sort_order')
            ->get(['id','name_fa','slug']);

        return response()->json(['sections' => $sections]);
    }

    public function grades(Request $request)
    {
        $sectionId = $request->get('section_id');

        $grades = Grade::where('is_active', 1)
            ->when($sectionId, fn($q)=>$q->where('section_id',$sectionId))
            ->orderBy('sort_order')
            ->get(['id','name_fa','slug','section_id']);

        return response()->json(['grades' => $grades]);
    }

    public function branches(Request $request)
    {
        $sectionId = $request->get('section_id');

        $branches = Branch::where('is_active', 1)
            ->when($sectionId, fn($q)=>$q->where('section_id',$sectionId))
            ->orderBy('sort_order')
            ->get(['id','name_fa','slug','section_id']);

        return response()->json(['branches' => $branches]);
    }

    public function fields(Request $request)
    {
        $branchId = $request->get('branch_id');

        $fields = Field::where('is_active', 1)
            ->when($branchId, fn($q)=>$q->where('branch_id',$branchId))
            ->orderBy('sort_order')
            ->get(['id','name_fa','slug','branch_id']);

        return response()->json(['fields' => $fields]);
    }

    public function subfields(Request $request)
    {
        $fieldId = $request->get('field_id');

        $subfields = Subfield::where('is_active', 1)
            ->when($fieldId, fn($q)=>$q->where('field_id',$fieldId))
            ->orderBy('sort_order')
            ->get(['id','name_fa','slug','field_id']);

        return response()->json(['subfields' => $subfields]);
    }

    public function subjects(Request $request)
    {
        $q = Subject::query()->where('is_active', 1);

        $resolveId = function(string $modelClass, $val) {
            if (!$val) return null;

            if (\Illuminate\Support\Str::isUuid($val)) {
                $row = $modelClass::where('uuid', $val)->first();
                return $row?->id;
            }

            return $val;
        };

        $gradeId    = $resolveId(Grade::class, $request->grade_id);
        $branchId   = $resolveId(Branch::class, $request->branch_id);
        $fieldId    = $resolveId(Field::class, $request->field_id);
        $subfieldId = $resolveId(Subfield::class, $request->subfield_id);

        if ($gradeId)    $q->where('grade_id', $gradeId);
        if ($branchId)   $q->where('branch_id', $branchId);
        if ($fieldId)    $q->where('field_id', $fieldId);
        if ($subfieldId) $q->where('subfield_id', $subfieldId);

        $typeId = $resolveId(SubjectType::class, $request->subject_type_id);
        if ($typeId) $q->where('subject_type_id', $typeId);

        return response()->json([
            'subjects' => $q->get([
                'uuid as id',
                'title_fa',
                'slug',
                'code',
                'hours',
            ]),
        ]);
    }

    public function subjectTypes(Request $request)
    {
        try {
            $q = SubjectType::query()->where('is_active', 1);

            if ($request->filled('grade_id') && \Schema::hasColumn('subject_types', 'grade_id')) {
                $q->where('grade_id', $request->grade_id);
            }
            if ($request->filled('branch_id') && \Schema::hasColumn('subject_types', 'branch_id')) {
                $q->where('branch_id', $request->branch_id);
            }
            if ($request->filled('field_id') && \Schema::hasColumn('subject_types', 'field_id')) {
                $q->where('field_id', $request->field_id);
            }
            if ($request->filled('subfield_id') && \Schema::hasColumn('subject_types', 'subfield_id')) {
                $q->where('subfield_id', $request->subfield_id);
            }

            $types = $q->orderBy('sort_order')->get([
                'uuid as id',
                'slug',
                'name_fa',
            ]);

            return response()->json([
                'subject_types' => $types,
            ]);

        } catch (\Throwable $e) {
            \Log::error('subjectTypes error: '.$e->getMessage(), [
                'trace' => $e->getTraceAsString()
            ]);

            return response()->json([
                'subject_types' => [],
                'message' => 'Server error in subjectTypes'
            ], 500);
        }
    }
}


==================== FILE: resources/views/dashboard/teacher/exams/create.blade.php ====================
@extends('layouts.app')
@section('title', 'ÿ≥ÿßÿÆÿ™ ÿ¢ÿ≤ŸÖŸàŸÜ ÿ¨ÿØ€åÿØ - SmartEdu')

@push('styles')
<style>
    /* ÿ™ŸÖ ŸÅ€åÿ±Ÿàÿ≤Ÿá‚Äåÿß€å - ÿ¢ÿ®€å ÿØÿ±€åÿß€å€å */
    :root {
        --primary: #00CED1;
        --primary-light: rgba(0, 206, 209, 0.1);
        --primary-gradient: linear-gradient(135deg, #00CED1, #20B2AA);
        --secondary: #4682B4;
        --secondary-light: rgba(70, 130, 180, 0.1);
        --accent: #48D1CC;
        --accent-light: rgba(72, 209, 204, 0.1);
        --success: #32CD32;
        --success-light: rgba(50, 205, 50, 0.1);
        --warning: #FFA500;
        --warning-light: rgba(255, 165, 0, 0.1);
        --light: #ffffff;
        --dark: #2F4F4F;
        --dark-light: #4A6F6F;
        --gray: #708090;
        --light-gray: #F0F8FF;
        --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.08);
        --shadow-md: 0 8px 20px rgba(0, 0, 0, 0.12);
        --shadow-lg: 0 12px 30px rgba(0, 0, 0, 0.16);
        --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.2);
        --radius-xl: 24px;
        --radius-lg: 20px;
        --radius-md: 16px;
        --radius-sm: 12px;
    }

    * { font-family: 'Vazirmatn', sans-serif; }

    body {
        background-color: #f8fcfc;
        color: var(--dark);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    .create-exam-container {
        max-width: 1100px;
        margin: 0 auto;
        padding: 20px 15px 80px;
        animation: fadeIn 0.6s ease both;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideInLeft {
        from { transform: translateX(-30px); opacity: 0; }
        to   { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideUp {
        from { transform: translateY(30px); opacity: 0; }
        to   { transform: translateY(0); opacity: 1; }
    }

    /* HEADER */
    .page-header {
        background: linear-gradient(135deg, rgba(0, 206, 209, 0.1), rgba(70, 130, 180, 0.1));
        border-radius: var(--radius-xl);
        padding: 25px 30px;
        margin-bottom: 30px;
        border: 2px solid rgba(0, 206, 209, 0.15);
        position: relative;
        overflow: hidden;
        animation: slideInLeft 0.5s ease-out;
    }
    .page-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 300px;
        height: 300px;
        background: radial-gradient(circle, rgba(0, 206, 209, 0.08), transparent 70%);
        border-radius: 50%;
    }
    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
        position: relative;
        z-index: 2;
    }
    .header-title h1 {
        font-weight: 900;
        font-size: 1.8rem;
        color: var(--dark);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .header-title h1::before {
        content: '';
        width: 8px;
        height: 40px;
        background: var(--primary-gradient);
        border-radius: 10px;
    }
    .header-subtitle {
        color: var(--gray);
        font-size: 1.05rem;
        line-height: 1.8;
        max-width: 600px;
    }
    .btn-back {
        padding: 12px 24px;
        border-radius: var(--radius-lg);
        font-weight: 800;
        font-size: 1rem;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        background: transparent;
        color: var(--dark);
        border: 2px solid var(--gray);
        transition: all 0.25s ease;
        text-decoration: none;
        white-space: nowrap;
    }
    .btn-back:hover {
        background: var(--light-gray);
        transform: translateY(-3px);
        box-shadow: var(--shadow-md);
    }

    /* PROGRESS */
    .progress-container { margin-bottom: 35px; animation: slideUp 0.5s ease-out; }
    .progress-bar {
        height: 8px;
        background: var(--light-gray);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 15px;
    }
    .progress-fill {
        height: 100%;
        background: var(--primary-gradient);
        border-radius: 4px;
        width: 12.5%;
        transition: width 0.6s ease;
    }
    .progress-steps {
        display: flex;
        justify-content: space-between;
        padding: 0 8px;
        gap: 6px;
        flex-wrap: wrap;
    }
    .step-item { text-align: center; flex: 1; min-width: 105px; }
    .step-number {
        width: 34px; height: 34px; border-radius: 50%;
        background: var(--light);
        border: 2px solid var(--light-gray);
        display: flex; align-items: center; justify-content: center;
        font-weight: 900; color: var(--gray);
        margin: 0 auto 6px;
        transition: all 0.3s;
        font-size: .9rem;
    }
    .step-item.active .step-number {
        background: var(--primary); color: white; border-color: var(--primary); transform: scale(1.08);
    }
    .step-item.completed .step-number {
        background: var(--success); color: white; border-color: var(--success);
    }
    .step-name {
        font-size: 0.82rem; font-weight: 800; color: var(--gray);
        transition: all .3s;
    }
    .step-item.active .step-name { color: var(--primary); font-weight: 900; }

    /* FORM CONTAINER */
    .form-container {
        background: var(--light);
        border-radius: var(--radius-xl);
        padding: 36px;
        box-shadow: var(--shadow-lg);
        border: 2px solid rgba(0, 206, 209, 0.08);
        position: relative;
        overflow: hidden;
        animation: slideUp 0.6s ease-out;
    }

    .form-section { display: none; animation: fadeIn .35s ease; }
    .form-section.active { display: block; }

    .section-header { margin-bottom: 25px; text-align: center; }
    .section-icon { font-size: 2.6rem; margin-bottom: 10px; color: var(--primary); }
    .section-title { font-weight: 900; font-size: 1.45rem; color: var(--dark); margin-bottom: 8px; }
    .section-description {
        color: var(--gray); font-size: 1.02rem; line-height: 1.7;
        max-width: 700px; margin: 0 auto;
    }

    /* SELECTION GRID (reusable cards) */
    .selection-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 16px;
        margin-top: 12px;
    }
    @media (max-width: 768px) {
        .selection-grid { grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 480px) {
        .selection-grid { grid-template-columns: 1fr; }
    }
    .selection-card {
        border: 3px solid var(--light-gray);
        border-radius: var(--radius-lg);
        padding: 18px 16px;
        text-align: center;
        cursor: pointer;
        transition: all 0.25s ease;
        background: var(--light);
        position: relative;
        overflow: hidden;
        min-height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 6px;
    }
    .selection-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); border-color: rgba(0,206,209,.35); }
    .selection-card.selected {
        border-color: var(--primary);
        background: linear-gradient(135deg, rgba(0, 206, 209, 0.06), rgba(70, 130, 180, 0.06));
        box-shadow: var(--shadow-md);
    }
    .selection-icon { font-size: 2rem; }
    .selection-name { font-weight: 900; font-size: 1.05rem; color: var(--dark); }
    .selection-description { color: var(--gray); font-size: 0.9rem; line-height: 1.6; margin: 0; }

    /* EXAM TYPE cards (step1) */
    .exam-type-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 18px; }
    @media (max-width: 768px) { .exam-type-grid { grid-template-columns: 1fr; } }
    .type-card {
        border: 3px solid var(--light-gray);
        border-radius: var(--radius-lg);
        padding: 22px 18px;
        text-align: center;
        cursor: pointer;
        transition: all 0.25s ease;
        background: var(--light);
        position: relative;
        overflow: hidden;
        min-height: 175px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 8px;
    }
    .type-card:hover { transform: translateY(-6px); box-shadow: var(--shadow-lg); }
    .type-card.selected {
        border-color: var(--primary);
        background: linear-gradient(135deg, rgba(0, 206, 209, 0.05), rgba(70, 130, 180, 0.05));
        box-shadow: var(--shadow-md);
    }
    .type-icon { font-size: 2.2rem; color: var(--primary); }
    .type-title { font-weight: 900; font-size: 1.1rem; color: var(--dark); }
    .type-description { color: var(--gray); font-size: 0.9rem; line-height: 1.6; margin:0; }
    .type-badge {
        position: absolute; top: 10px; left: 10px;
        background: var(--primary); color: #fff;
        padding: 4px 12px; border-radius: 999px;
        font-size: .75rem; font-weight: 900;
    }

    /* SUBJECTS LIST (step7) */
    .subjects-wrap { margin-top: 8px; }
    .subject-item {
        display: flex; align-items: center; gap: 12px;
        background: var(--light);
        border: 2px solid var(--light-gray);
        border-radius: var(--radius-md);
        padding: 12px 14px;
        margin-bottom: 10px;
        transition: all .2s ease;
    }
    .subject-item:hover { border-color: rgba(0,206,209,.35); box-shadow: var(--shadow-sm); }
    .subject-checkbox input { width: 18px; height: 18px; cursor: pointer; }
    .subject-info { flex:1; text-align:right; }
    .subject-name { font-weight: 900; font-size: 1rem; margin-bottom: 4px; }
    .subject-meta { color: var(--gray); font-size: .85rem; display:flex; gap:10px; flex-wrap:wrap; }
    .subject-code { background: var(--light-gray); padding:2px 8px; border-radius: 6px; }

    /* PREVIEW (step8) */
    .preview-section {
        background: linear-gradient(135deg, rgba(0, 206, 209, 0.05), rgba(70, 130, 180, 0.05));
        border-radius: var(--radius-xl);
        padding: 22px;
        margin-bottom: 25px;
        border: 2px solid var(--primary-light);
    }
    .preview-title {
        font-weight: 900; color: var(--dark);
        margin-bottom: 14px; display:flex; align-items:center; gap:8px;
        font-size: 1.15rem;
    }
    .preview-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:12px;
    }
    .preview-item {
        background: var(--light); border-radius: var(--radius-md); padding: 12px;
        border: 2px solid var(--light-gray);
    }
    .preview-label { font-size: .85rem; color: var(--gray); font-weight: 700; margin-bottom: 4px; }
    .preview-value { font-weight: 900; color: var(--dark); font-size: 1rem; }

    /* DETAILS FORM (step8) */
    .details-form { max-width: 650px; margin: 0 auto; }
    .form-group { margin-bottom: 20px; }
    .form-label {
        color: var(--dark);
        font-weight: 900; font-size: 1rem; margin-bottom: 10px;
        display:flex; align-items:center; gap:8px;
    }
    .form-label i {
        color: var(--primary);
        background: var(--primary-light);
        width: 34px; height: 34px; border-radius: 10px;
        display:flex; align-items:center; justify-content:center; font-size:1rem;
    }
    .form-input, .form-textarea {
        width: 100%; padding: 14px 16px;
        border: 2px solid var(--light-gray);
        border-radius: var(--radius-md);
        background: var(--light); color: var(--dark);
        font-weight: 700; font-size: 1rem;
        transition: all .25s ease;
    }
    .form-textarea { min-height: 110px; resize: vertical; line-height: 1.7; }
    .form-input:focus, .form-textarea:focus {
        outline: none; border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0, 206, 209, 0.2);
    }

    .checkbox-group {
        background: var(--light-gray);
        border-radius: var(--radius-lg);
        padding: 16px;
        margin-top: 12px;
    }
    .form-check { display:flex; align-items:center; gap:10px; }
    .form-check-input { width: 20px; height: 20px; cursor: pointer; }
    .form-check-label { font-weight: 900; font-size: 1rem; cursor: pointer; }
    .form-text { font-size: .9rem; color: var(--gray); margin-top: 8px; }

    /* NAV BUTTONS */
    .nav-buttons {
        display: flex; justify-content: space-between;
        margin-top: 30px; gap: 12px;
    }
    .btn-nav {
        padding: 14px 26px;
        border-radius: var(--radius-lg);
        font-weight: 900; font-size: 1rem;
        display:flex; align-items:center; gap:8px; justify-content:center;
        cursor:pointer; border:2px solid transparent; min-width: 150px;
        transition: all .25s ease;
    }
    .btn-prev { background: transparent; color: var(--dark); border:2px solid var(--gray); }
    .btn-prev:hover { background: var(--light-gray); transform: translateY(-2px); box-shadow: var(--shadow-sm); }
    .btn-next { background: var(--primary-gradient); color:#fff; box-shadow: 0 8px 18px rgba(0,206,209,.3); }
    .btn-next:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,206,209,.4); }
    .btn-submit { background: var(--success); color:#fff; box-shadow: 0 8px 18px rgba(50,205,50,.3); }
    .btn-submit:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(50,205,50,.4); }

    @media (max-width: 768px) {
        .form-container { padding: 22px; }
        .header-title h1 { font-size: 1.5rem; }
        .nav-buttons { flex-direction: column; }
        .btn-nav { width: 100%; min-width: unset; }
    }
</style>
@endpush

@section('content')
<div class="create-exam-container">

    {{-- HEADER --}}
    <div class="page-header">
        <div class="header-content">
            <div class="header-title">
                <h1>
                    <span style="background: linear-gradient(120deg, var(--primary) 0%, var(--secondary) 100%);
                                 -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                        ÿ≥ÿßÿÆÿ™ ÿ¢ÿ≤ŸÖŸàŸÜ ÿ¨ÿØ€åÿØ
                    </span>
                    üìù
                </h1>
                <p class="header-subtitle">ÿ¢ÿ≤ŸÖŸàŸÜ ÿÆŸàÿØ ÿ±ÿß ÿ®Ÿá ÿµŸàÿ±ÿ™ ŸÖÿ±ÿ≠ŸÑŸá‚Äåÿß€å Ÿà ÿ®ÿß ÿØŸÇÿ™ ÿß€åÿ¨ÿßÿØ ⁄©ŸÜ€åÿØ.</p>
            </div>

            <a href="{{ route('teacher.exams.index') }}" class="btn-back">
                <i class="fas fa-arrow-right"></i>
                ÿ®ÿßÿ≤⁄Øÿ¥ÿ™ ÿ®Ÿá ŸÑ€åÿ≥ÿ™ ÿ¢ÿ≤ŸÖŸàŸÜ‚ÄåŸáÿß
            </a>
        </div>
    </div>

    {{-- PROGRESS --}}
    <div class="progress-container">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-steps">
            <div class="step-item active" data-step="1">
                <div class="step-number">€±</div>
                <div class="step-name">ŸÜŸàÿπ ÿ¢ÿ≤ŸÖŸàŸÜ</div>
            </div>
            <div class="step-item" data-step="2">
                <div class="step-number">€≤</div>
                <div class="step-name">Ÿæÿß€åŸá ÿ™ÿ≠ÿµ€åŸÑ€å</div>
            </div>
            <div class="step-item" data-step="3">
                <div class="step-number">€≥</div>
                <div class="step-name">ÿ¥ÿßÿÆŸá ÿ™ÿ≠ÿµ€åŸÑ€å</div>
            </div>
            <div class="step-item" data-step="4">
                <div class="step-number">€¥</div>
                <div class="step-name">ÿ≤ŸÖ€åŸÜŸá ŸÅŸÜ€å</div>
            </div>
            <div class="step-item" data-step="5">
                <div class="step-number">€µ</div>
                <div class="step-name">ÿ≤€åÿ±ÿ±ÿ¥ÿ™Ÿá</div>
            </div>
            <div class="step-item" data-step="6">
                <div class="step-number">€∂</div>
                <div class="step-name">ÿØÿ≥ÿ™Ÿá ÿØÿ±ÿ≥€å</div>
            </div>
            <div class="step-item" data-step="7">
                <div class="step-number">€∑</div>
                <div class="step-name">ÿßŸÜÿ™ÿÆÿßÿ® ÿØÿ±ÿ≥</div>
            </div>
            <div class="step-item" data-step="8">
                <div class="step-number">€∏</div>
                <div class="step-name">ÿ¨ÿ≤ÿ¶€åÿßÿ™</div>
            </div>
        </div>
    </div>

    {{-- FORM --}}
    <div class="form-container">
@if ($errors->any())
    <div class="alert alert-danger">
        <ul class="mb-0">
            @foreach ($errors->all() as $error)
                <li>{{ $error }}</li>
            @endforeach
        </ul>
    </div>
@endif

        <form method="POST" action="{{ route('teacher.exams.store') }}" id="examForm" onsubmit="return validateFinalStep()">
            @csrf

            {{-- Hidden Inputs (JS fills these) --}}
            <input type="hidden" name="exam_type" id="examType" value="public">
            <input type="hidden" name="classroom_id" id="classroomId" value="{{ $selectedClassroomId ?? '' }}">

            <input type="hidden" name="section_id" id="sectionId">
            <input type="hidden" name="grade_id" id="gradeId">
            <input type="hidden" name="branch_id" id="branchId">
            <input type="hidden" name="field_id" id="fieldId">
            <input type="hidden" name="subfield_id" id="subfieldId">
            <input type="hidden" name="subject_type_id" id="subjectTypeId">
            <input type="hidden" name="subjects" id="subjectsInput">

            {{-- STEP 1 --}}
            <div class="form-section active" id="step1">
                <div class="section-header">
                    <div class="section-icon">üéØ</div>
                    <h2 class="section-title">ŸÜŸàÿπ ÿ¢ÿ≤ŸÖŸàŸÜ ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ</h2>
                    <p class="section-description">€å⁄©€å ÿßÿ≤ ⁄Øÿ≤€åŸÜŸá‚ÄåŸáÿß€å ÿ≤€åÿ± ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ŸÜŸÖÿß€å€åÿØ.</p>
                </div>

                <div class="exam-type-grid">
                    <div class="type-card" data-type="public" onclick="selectExamType('public')">
                        <div class="type-icon">üåê</div>
                        <div class="type-title">ÿ¢ÿ≤ŸÖŸàŸÜ ÿπŸÖŸàŸÖ€å</div>
                        <p class="type-description">ÿ®ÿ±ÿß€å ÿ™ŸÖÿßŸÖ ŸáŸÜÿ±ÿ¨Ÿà€åÿßŸÜ ŸÇÿßÿ®ŸÑ ÿØÿ≥ÿ™ÿ±ÿ≥€å ÿßÿ≥ÿ™.</p>
                        <div class="type-badge">ÿπŸÖŸàŸÖ€å</div>
                    </div>

                    <div class="type-card" data-type="class_single" onclick="selectExamType('class_single')">
                        <div class="type-icon">üìö</div>
                        <div class="type-title">⁄©ŸÑÿßÿ≥€å ÿ™⁄©‚ÄåÿØÿ±ÿ≥</div>
                        <p class="type-description">ŸÅŸÇÿ∑ ÿ®ÿ±ÿß€å €å⁄© ⁄©ŸÑÿßÿ≥ Ÿà €å⁄© ÿØÿ±ÿ≥ ŸÖÿ¥ÿÆÿµ.</p>
                        <div class="type-badge">ÿ™ÿÆÿµÿµ€å</div>
                    </div>

                    <div class="type-card" data-type="class_comprehensive" onclick="selectExamType('class_comprehensive')">
                        <div class="type-icon">üéì</div>
                        <div class="type-title">⁄©ŸÑÿßÿ≥€å ÿ¨ÿßŸÖÿπ</div>
                        <p class="type-description">ÿ®ÿ±ÿß€å €å⁄© ⁄©ŸÑÿßÿ≥ ÿ¥ÿßŸÖŸÑ ŸáŸÖŸá ÿØÿ±Ÿàÿ≥ Ÿæÿß€åŸá.</p>
                        <div class="type-badge">ÿ¨ÿßŸÖÿπ</div>
                    </div>
                </div>

                {{-- Classroom selection (only for class exams) --}}
                <div id="classroomSelectionSection" style="display:none; margin-top:24px;">
                    <div class="section-header" style="margin-bottom:12px;">
                        <h3 class="section-title" style="font-size:1.2rem;">⁄©ŸÑÿßÿ≥ ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ</h3>
                        <p class="section-description">⁄©ŸÑÿßÿ≥‚ÄåŸáÿß€å ÿ¥ŸÖÿß ÿßÿ≤ ÿ≥€åÿ≥ÿ™ŸÖ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ŸÖ€å‚Äåÿ¥ŸàŸÜÿØ.</p>
                    </div>

                    <div class="selection-grid" id="existingClassroomsContainer"></div>

                    <div style="text-align:center; margin-top:14px;">
                        <button type="button" class="btn-nav btn-prev" onclick="createNewClassroom()" style="border-color:var(--primary); color:var(--primary);">
                            <i class="fas fa-plus-circle"></i>
                            ÿß€åÿ¨ÿßÿØ ⁄©ŸÑÿßÿ≥ ÿ¨ÿØ€åÿØ
                        </button>
                    </div>
                </div>
            </div>

            {{-- STEP 2 --}}
            <div class="form-section" id="step2">
                <div class="section-header">
                    <div class="section-icon">üìä</div>
                    <h2 class="section-title">Ÿæÿß€åŸá ÿ™ÿ≠ÿµ€åŸÑ€å ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ</h2>
                    <p class="section-description">Ÿæÿß€åŸáŸî ŸÖŸàÿ±ÿØ ŸÜÿ∏ÿ± ÿ¢ÿ≤ŸÖŸàŸÜ ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ŸÜŸÖÿß€å€åÿØ.</p>
                </div>

                <div class="selection-grid" id="gradesGrid"></div>
            </div>

            {{-- STEP 3 --}}
            <div class="form-section" id="step3">
                <div class="section-header">
                    <div class="section-icon">üéì</div>
                    <h2 class="section-title">ÿ¥ÿßÿÆŸá ÿ™ÿ≠ÿµ€åŸÑ€å ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ</h2>
                    <p class="section-description">ÿ¥ÿßÿÆŸáŸî ÿ¢ŸÖŸàÿ≤ÿ¥€å ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ŸÜŸÖÿß€å€åÿØ.</p>
                </div>

                <div class="selection-grid" id="branchesGrid"></div>
            </div>

            {{-- STEP 4 --}}
            <div class="form-section" id="step4">
                <div class="section-header">
                    <div class="section-icon">üè≠</div>
                    <h2 class="section-title">ÿ≤ŸÖ€åŸÜŸá ÿ¢ŸÖŸàÿ≤ÿ¥€å ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ</h2>
                    <p class="section-description">ÿ≤ŸÖ€åŸÜŸáŸî ÿ¢ŸÖŸàÿ≤ÿ¥€å ŸÖÿ±ÿ™ÿ®ÿ∑ ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ŸÜŸÖÿß€å€åÿØ.</p>
                </div>

                <div class="selection-grid" id="fieldsGrid"></div>
            </div>

            {{-- STEP 5 --}}
            <div class="form-section" id="step5">
                <div class="section-header">
                    <div class="section-icon">üî¨</div>
                    <h2 class="section-title">ÿ≤€åÿ±ÿ±ÿ¥ÿ™Ÿá ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ</h2>
                    <p class="section-description">ÿ≤€åÿ±ÿ±ÿ¥ÿ™ŸáŸî ŸÖŸàÿ±ÿØ ŸÜÿ∏ÿ± ÿ±ÿß ŸÖÿ¥ÿÆÿµ ŸÜŸÖÿß€å€åÿØ.</p>
                </div>

                <div class="selection-grid" id="subfieldGrid"></div>
            </div>

            {{-- STEP 6 --}}
            <div class="form-section" id="step6">
                <div class="section-header">
                    <div class="section-icon">üìö</div>
                    <h2 class="section-title">ÿØÿ≥ÿ™Ÿá ÿØÿ±ÿ≥€å ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ</h2>
                    <p class="section-description">ÿØÿ≥ÿ™ŸáŸî ÿØÿ±ÿ≥€å ÿ¢ÿ≤ŸÖŸàŸÜ ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ŸÜŸÖÿß€å€åÿØ.</p>
                </div>

                <div class="selection-grid" id="subjectTypesGrid"></div>
            </div>

            {{-- STEP 7 --}}
            <div class="form-section" id="step7">
                <div class="section-header">
                    <div class="section-icon">üìñ</div>
                    <h2 class="section-title">ÿØÿ±ÿ≥(Ÿáÿß) ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ</h2>
                    <p class="section-description">ÿ®ÿ± ÿßÿ≥ÿßÿ≥ ŸÜŸàÿπ ÿ¢ÿ≤ŸÖŸàŸÜÿå ÿØÿ±ÿ≥‚ÄåŸáÿß€å ŸÖŸàÿ±ÿØ ŸÜÿ∏ÿ± ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ŸÜŸÖÿß€å€åÿØ.</p>
                </div>

                <div class="subjects-wrap" id="subjectsContainer"></div>
            </div>

            {{-- STEP 8 --}}
            <div class="form-section" id="step8">
                <div class="section-header">
                    <div class="section-icon">‚úèÔ∏è</div>
                    <h2 class="section-title">ÿ¨ÿ≤ÿ¶€åÿßÿ™ ÿ¢ÿ≤ŸÖŸàŸÜ ÿ±ÿß ÿ™⁄©ŸÖ€åŸÑ ⁄©ŸÜ€åÿØ</h2>
                    <p class="section-description">ÿßÿ∑ŸÑÿßÿπÿßÿ™ ÿ™⁄©ŸÖ€åŸÑ€å ÿ¢ÿ≤ŸÖŸàŸÜ ÿ±ÿß Ÿàÿßÿ±ÿØ ŸÜŸÖÿß€å€åÿØ.</p>
                </div>

                {{-- Preview --}}
                <div class="preview-section">
                    <div class="preview-title">
                        <i class="fas fa-eye"></i>
                        Ÿæ€åÿ¥‚ÄåŸÜŸÖÿß€åÿ¥ ÿ¢ÿ≤ŸÖŸàŸÜ
                    </div>
                    <div class="preview-grid">
                        <div class="preview-item">
                            <div class="preview-label">ŸÜŸàÿπ ÿ¢ÿ≤ŸÖŸàŸÜ</div>
                            <div class="preview-value" id="previewExamType">--</div>
                        </div>
                        <div class="preview-item">
                            <div class="preview-label">Ÿæÿß€åŸá ÿ™ÿ≠ÿµ€åŸÑ€å</div>
                            <div class="preview-value" id="previewGrade">--</div>
                        </div>
                        <div class="preview-item">
                            <div class="preview-label">ÿ¥ÿßÿÆŸá ÿ™ÿ≠ÿµ€åŸÑ€å</div>
                            <div class="preview-value" id="previewBranch">--</div>
                        </div>
                        <div class="preview-item">
                            <div class="preview-label">ÿ≤ŸÖ€åŸÜŸá ŸÅŸÜ€å</div>
                            <div class="preview-value" id="previewField">--</div>
                        </div>
                        <div class="preview-item">
                            <div class="preview-label">ÿ≤€åÿ±ÿ±ÿ¥ÿ™Ÿá</div>
                            <div class="preview-value" id="previewSubfield">--</div>
                        </div>
                        <div class="preview-item">
                            <div class="preview-label">ÿØÿ≥ÿ™Ÿá ÿØÿ±ÿ≥€å</div>
                            <div class="preview-value" id="previewSubjectType">--</div>
                        </div>
                        <div class="preview-item">
                            <div class="preview-label">ÿ™ÿπÿØÿßÿØ ÿØÿ±ÿ≥‚ÄåŸáÿß€å ÿßŸÜÿ™ÿÆÿßÿ®€å</div>
                            <div class="preview-value" id="previewSubjectsCount">--</div>
                        </div>
                        <div class="preview-item">
                            <div class="preview-label">ÿ™ÿπÿØÿßÿØ ÿ≥ŸàÿßŸÑÿßÿ™ Ÿæ€åÿ¥ŸÜŸáÿßÿØ€å</div>
                            <div class="preview-value" id="previewTotalQuestions">--</div>
                        </div>
                    </div>
                </div>

                {{-- Details Form --}}
                <div class="details-form">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-heading"></i>
                            ÿπŸÜŸàÿßŸÜ ÿ¢ÿ≤ŸÖŸàŸÜ
                        </label>
                        <input type="text" name="title" class="form-input"
                               value="{{ old('title') }}"
                               placeholder="ŸÖÿ´ÿßŸÑ: ÿ¢ÿ≤ŸÖŸàŸÜ ŸÅÿµŸÑ €± ÿ¥ÿ®⁄©Ÿá"
                               required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-clock"></i>
                            ŸÖÿØÿ™ ÿ≤ŸÖÿßŸÜ ÿ¢ÿ≤ŸÖŸàŸÜ (ÿØŸÇ€åŸÇŸá)
                        </label>
                        <input type="number" name="duration" class="form-input"
                               value="{{ old('duration', 60) }}"
                               min="5" max="300" step="5" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-align-left"></i>
                            ÿ™Ÿàÿ∂€åÿ≠ÿßÿ™ ÿ¢ÿ≤ŸÖŸàŸÜ
                        </label>
                        <textarea name="description" class="form-textarea" rows="4"
                                  placeholder="ŸáÿØŸÅ ÿ¢ÿ≤ŸÖŸàŸÜÿå ŸÜ⁄©ÿßÿ™ ŸÖŸáŸÖ Ÿà ...">{{ old('description') }}</textarea>
                    </div>

                    <div class="checkbox-group">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_active" id="activeCheck" value="1" checked>
                            <label class="form-check-label" for="activeCheck">ÿ¢ÿ≤ŸÖŸàŸÜ ÿ®ŸÑÿßŸÅÿßÿµŸÑŸá ŸÅÿπÿßŸÑ ÿ¥ŸàÿØ</label>
                        </div>
                        <div class="form-text">
                            ÿØÿ± ÿµŸàÿ±ÿ™ ÿπÿØŸÖ ÿßŸÜÿ™ÿÆÿßÿ®ÿå ÿ¢ÿ≤ŸÖŸàŸÜ ÿ®Ÿá ÿµŸàÿ±ÿ™ Ÿæ€åÿ¥‚ÄåŸÜŸà€åÿ≥ ÿ∞ÿÆ€åÿ±Ÿá ŸÖ€å‚Äåÿ¥ŸàÿØ.
                        </div>
                    </div>
                </div>
            </div>

{{-- ========== NAVIGATION BUTTONS ========== --}}
<div class="nav-buttons">
    <button type="button" class="btn-nav btn-prev" onclick="prevStep()">
        <i class="fas fa-arrow-right"></i>
        ŸÖÿ±ÿ≠ŸÑŸá ŸÇÿ®ŸÑ
    </button>

    <button type="button" class="btn-nav btn-next" onclick="nextStep()">
        ŸÖÿ±ÿ≠ŸÑŸá ÿ®ÿπÿØ
        <i class="fas fa-arrow-left"></i>
    </button>

    <button type="submit" class="btn-nav btn-submit">
        <i class="fas fa-check"></i>
        ÿß€åÿ¨ÿßÿØ ÿ¢ÿ≤ŸÖŸàŸÜ
    </button>
</div>

        </form>
    </div>
</div>
@endsection

@push('scripts')
<script src="{{ asset('assets/js/exam-wizard.js') }}"></script>
<script src="{{ asset('assets/js/classroom-modal.js') }}"></script>
@endpush


==================== FILE: resources/views/dashboard/teacher/exams/edit.blade.php ====================
{{-- resources/views/dashboard/teacher/exams/edit.blade.php --}}
@extends('layouts.app')
@section('title', 'Ÿà€åÿ±ÿß€åÿ¥ ÿ¢ÿ≤ŸÖŸàŸÜ')

@push('styles')
    <style>
        .form-card {
            border: 0;
            border-radius: 1.25rem;
            background: #fff;
            box-shadow: 0 8px 24px rgba(18, 38, 63, .06)
        }

        .step-pill {
            border-radius: 999px;
            padding: .35rem .8rem;
            font-weight: 700;
            font-size: .85rem;
            background: #f8fafc;
            color: #334155;
            display: inline-flex;
            align-items: center;
            gap: .4rem
        }

        .step-pill .dot {
            width: 9px;
            height: 9px;
            border-radius: 50%;
            background: #16a34a;
            box-shadow: 0 0 0 4px rgba(22, 163, 74, .12)
        }

        .input-soft {
            border: 0;
            box-shadow: 0 6px 18px rgba(18, 38, 63, .06);
            border-radius: .9rem;
            padding: .7rem .9rem
        }

        .input-soft:focus {
            box-shadow: 0 0 0 .25rem rgba(13, 110, 253, .15)
        }

        .hint {
            font-size: .85rem;
            color: #6c757d
        }

        .preview-card {
            border: 1px dashed #e2e8f0;
            border-radius: 1.25rem;
            background: linear-gradient(180deg, #fff, #f8fafc)
        }

        .preview-badge {
            background: rgba(16, 185, 129, .12);
            color: #059669;
            font-weight: 800
        }

        .btn-wizard {
            border-radius: 1rem;
            padding: .7rem 1rem;
            display: inline-flex;
            align-items: center;
            gap: .5rem
        }

        .floating-help {
            position: sticky;
            top: 90px
        }

        .danger-zone {
            border: 1px solid rgba(220, 53, 69, .2);
            background: rgba(220, 53, 69, .04);
            border-radius: 1rem
        }
    </style>
@endpush

@section('content')
    <div class="container-fluid">

        {{-- Header --}}
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2 fade-up">
            <div>
                <h4 class="fw-bold mb-1"><i class="bi bi-pencil-square me-1 text-warning"></i> Ÿà€åÿ±ÿß€åÿ¥ ÿ¢ÿ≤ŸÖŸàŸÜ</h4>
                <div class="text-muted small">
                    ÿ™ÿ∫€å€åÿ±ÿßÿ™ ÿ±ÿß ÿßÿπŸÖÿßŸÑ ⁄©ŸÜ Ÿà ÿ∞ÿÆ€åÿ±Ÿá ÿ®ÿ≤ŸÜ. Ÿàÿ∂ÿπ€åÿ™ ÿßŸÜÿ™ÿ¥ÿßÿ± Ÿà ÿ™ÿßÿ±€åÿÆ ÿ±ÿß ŸáŸÖ ŸÖ€å‚Äåÿ™ŸàÿßŸÜ€å ÿ¢ŸæÿØ€åÿ™ ⁄©ŸÜ€å.
                </div>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ route('teacher.exams.questions.index', $exam) }}"
                   class="btn btn-outline-primary d-inline-flex align-items-center gap-2 shadow-sm">
                    <i class="bi bi-question-circle"></i>
                    ŸÖÿØ€åÿ±€åÿ™ ÿ≥ŸàÿßŸÑ‚ÄåŸáÿß
                </a>
                <a href="{{ route('teacher.exams.index') }}"
                   class="btn btn-outline-secondary d-inline-flex align-items-center gap-2 shadow-sm">
                    <i class="bi bi-arrow-right"></i>
                    ÿ®ÿßÿ≤⁄Øÿ¥ÿ™
                </a>
            </div>
        </div>

        {{-- Validation errors --}}
        @if ($errors->any())
            <div class="alert alert-danger fade-up">
                <div class="fw-semibold mb-2">
                    <i class="bi bi-exclamation-triangle-fill me-1"></i>
                    ŸÑÿ∑ŸÅÿßŸã ÿÆÿ∑ÿßŸáÿß€å ÿ≤€åÿ± ÿ±ÿß ÿ®ÿ±ÿ±ÿ≥€å ⁄©ŸÜ:
                </div>
                <ul class="mb-0">
                    @foreach ($errors->all() as $error)
                        <li>{{ $error }}</li>
                    @endforeach
                </ul>
            </div>
        @endif

        @if (session('success'))
            <div class="alert alert-success fade-up">
                <i class="bi bi-check-circle-fill me-1"></i>
                {{ session('success') }}
            </div>
        @endif

        <div class="row g-3">

            {{-- Form column --}}
            <div class="col-lg-8">
                <div class="form-card p-3 p-md-4 fade-up">

                    <div class="d-flex flex-wrap align-items-center justify-content-between mb-3 gap-2">
                        <div class="step-pill"><span class="dot"></span> Ÿà€åÿ±ÿß€åÿ¥ ÿßÿ∑ŸÑÿßÿπÿßÿ™ ÿ¢ÿ≤ŸÖŸàŸÜ</div>
                        <div class="hint">* ŸÅ€åŸÑÿØŸáÿß€å ÿ≥ÿ™ÿßÿ±Ÿá‚ÄåÿØÿßÿ± ÿ∂ÿ±Ÿàÿ±€å‚ÄåÿßŸÜÿØ.</div>
                    </div>

                    <form action="{{ route('teacher.exams.update', $exam) }}" method="POST" class="row g-3" novalidate>
                        @csrf
                        @method('PUT')

                        {{-- Title --}}
                        <div class="col-12">
                            <label class="form-label fw-semibold">ÿπŸÜŸàÿßŸÜ ÿ¢ÿ≤ŸÖŸàŸÜ <span class="text-danger">*</span></label>
                            <input type="text"
                                   name="title"
                                   class="form-control input-soft"
                                   placeholder="ŸÖÿ´ŸÑÿßŸã: ÿ¢ÿ≤ŸÖŸàŸÜ ŸÅÿµŸÑ €± ÿ±€åÿßÿ∂€å"
                                   value="{{ old('title', $exam->title) }}"
                                   required>
                        </div>

                        {{-- Scope + Classroom --}}
                        <div class="col-12">
                            <label class="form-label fw-semibold d-block">ŸÜŸàÿπ ÿ¢ÿ≤ŸÖŸàŸÜ <span class="text-danger">*</span></label>

@php
    // 1) ÿß⁄Øÿ± ŸÅÿ±ŸÖ ÿ®ÿß ÿÆÿ∑ÿß ÿ®ÿ±⁄Øÿ¥ÿ™Ÿáÿå ŸÖŸÇÿØÿßÿ± ŸáŸÖÿßŸÜ old('scope')
    $scopeVal = old('scope');

    // 2) ÿß⁄Øÿ± ŸáŸÜŸàÿ≤ ŸÖŸÇÿØÿßÿ± ÿ™ÿπ€å€åŸÜ ŸÜÿ¥ÿØŸá:
    if (!$scopeVal) {
        if (!empty($exam->scope)) {
            // ÿß⁄Øÿ± ÿ™Ÿà€å DB scope ÿØÿßÿ±€åŸÖÿå ŸáŸÖÿßŸÜ ÿ±ÿß ÿ®⁄Ø€åÿ±
            $scopeVal = $exam->scope;
        } else {
            // ÿß⁄Øÿ± scope ÿÆÿßŸÑ€å ÿßÿ≥ÿ™ÿå ÿßÿ≤ ŸÜŸàÿπ ÿ¢ÿ≤ŸÖŸàŸÜ ÿ≠ÿØÿ≥ ÿ®ÿ≤ŸÜ
            // public = ÿ¢ÿ≤ÿßÿØ    |   ÿ®ŸÇ€åŸá = ⁄©ŸÑÿßÿ≥€å
            $scopeVal = $exam->exam_type === 'public' ? 'free' : 'classroom';
        }
    }
@endphp

                            <div class="form-check form-check-inline">
                                <input class="form-check-input"
                                       type="radio"
                                       name="scope"
                                       id="editScopeClassroom"
                                       value="classroom"
                                    {{ $scopeVal === 'classroom' ? 'checked' : '' }}>
                                <label class="form-check-label" for="editScopeClassroom">⁄©ŸÑÿßÿ≥€å</label>
                            </div>

                            <div class="form-check form-check-inline">
                                <input class="form-check-input"
                                       type="radio"
                                       name="scope"
                                       id="editScopeFree"
                                       value="free"
                                    {{ $scopeVal === 'free' ? 'checked' : '' }}>
                                <label class="form-check-label" for="editScopeFree">ÿ¢ÿ≤ÿßÿØ</label>
                            </div>

                            <div class="hint mt-1">ÿß⁄Øÿ± ÿ¢ÿ≤ŸÖŸàŸÜ ÿ¢ÿ≤ÿßÿØ ÿ®ÿßÿ¥ÿØÿå ÿ®Ÿá Ÿá€å⁄Ü ⁄©ŸÑÿßÿ≥€å ŸàÿµŸÑ ŸÜ€åÿ≥ÿ™.</div>
                        </div>

                        <div class="col-md-6" id="editClassroomBox">
                            <label class="form-label fw-semibold">⁄©ŸÑÿßÿ≥ ŸÖÿ±ÿ®Ÿàÿ∑Ÿá <span class="text-danger">*</span></label>
                            <select name="classroom_id" class="form-select input-soft">
                                <option value="">ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÑÿßÿ≥...</option>
                                @foreach ($classrooms as $c)
                                    <option value="{{ $c->id }}"
                                        {{ (string) old('classroom_id', $exam->classroom_id) === (string) $c->id ? 'selected' : '' }}>
                                        {{ $c->title ?? $c->name }}
                                    </option>
                                @endforeach
                            </select>
                        </div>

                        {{-- Subject & Level --}}
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">ÿØÿ±ÿ≥ / ŸÖŸàÿ∂Ÿàÿπ <span class="text-danger">*</span></label>
                            <select name="subject" class="form-select input-soft" required>
                                <option value="" disabled {{ old('subject', $exam->subject) ? '' : 'selected' }}>ÿßŸÜÿ™ÿÆÿßÿ® ÿØÿ±ÿ≥</option>
                                @foreach ($subjects ?? [] as $s)
                                    <option value="{{ $s }}"
                                        {{ old('subject', $exam->subject) === $s ? 'selected' : '' }}>
                                        {{ $s }}
                                    </option>
                                @endforeach
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold">ÿ≥ÿ∑ÿ≠ ÿ¢ÿ≤ŸÖŸàŸÜ <span class="text-danger">*</span></label>
                            @php $lvl = old('level', $exam->level ?? 'taghviyati'); @endphp
                            <select name="level" class="form-select input-soft" required>
                                <option value="taghviyati" {{ $lvl === 'taghviyati' ? 'selected' : '' }}>ÿ™ŸÇŸà€åÿ™€å</option>
                                <option value="konkur" {{ $lvl === 'konkur' ? 'selected' : '' }}>⁄©ŸÜ⁄©Ÿàÿ±</option>
                                <option value="olympiad" {{ $lvl === 'olympiad' ? 'selected' : '' }}>ÿßŸÑŸÖŸæ€åÿßÿØ</option>
                            </select>
                        </div>

                        {{-- Duration & Start time --}}
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">ŸÖÿØÿ™ ÿ¢ÿ≤ŸÖŸàŸÜ (ÿØŸÇ€åŸÇŸá) <span class="text-danger">*</span></label>
                            <input type="number"
                                   min="1"
                                   name="duration"
                                   class="form-control input-soft"
                                   value="{{ old('duration', $exam->duration_minutes) }}"
                                   required>
                        </div>

                        <div class="col-md-8">
                            <label class="form-label fw-semibold">ÿ™ÿßÿ±€åÿÆ Ÿà ÿ≤ŸÖÿßŸÜ ÿ¥ÿ±Ÿàÿπ</label>
                            <input type="datetime-local"
                                   name="start_at"
                                   class="form-control input-soft"
                                   value="{{ old('start_at', optional($exam->start_at)->format('Y-m-d\TH:i')) }}">
                            <div class="hint mt-1">ÿ™ÿßÿ±€åÿÆ/ÿ≤ŸÖÿßŸÜ ÿ±ÿß ÿ®ÿ±ÿß€å ŸáŸÖÿßŸáŸÜ⁄Ø€å ÿ®ÿ±⁄Øÿ≤ÿßÿ±€å ÿ™ŸÜÿ∏€åŸÖ ⁄©ŸÜ.</div>
                        </div>

                        {{-- Description --}}
                        <div class="col-12">
                            <label class="form-label fw-semibold">ÿ™Ÿàÿ∂€åÿ≠ÿßÿ™</label>
                            <textarea name="description"
                                      rows="4"
                                      class="form-control input-soft"
                                      placeholder="ÿ™Ÿàÿ∂€åÿ≠ÿßÿ™ ⁄©Ÿàÿ™ÿßŸá ÿØÿ±ÿ®ÿßÿ±Ÿá ŸáÿØŸÅ ÿ¢ÿ≤ŸÖŸàŸÜ...">{{ old('description', $exam->description) }}</textarea>
                        </div>

                        {{-- Publish toggle --}}
                        <div class="col-12">
                            @php $pub = old('is_published', $exam->is_published); @endphp
                            <div class="form-check form-switch">
                                <input class="form-check-input"
                                       type="checkbox"
                                       role="switch"
                                       id="publishSwitch"
                                       name="is_published"
                                       value="1"
                                    {{ $pub ? 'checked' : '' }}>
                                <label class="form-check-label fw-semibold" for="publishSwitch">ÿ¢ÿ≤ŸÖŸàŸÜ ŸÖŸÜÿ™ÿ¥ÿ± ÿ®ÿßÿ¥ÿØ</label>
                            </div>
                            <div class="hint mt-1">ÿØÿ± ÿµŸàÿ±ÿ™ ÿßŸÜÿ™ÿ¥ÿßÿ±ÿå ÿ¢ÿ≤ŸÖŸàŸÜ ÿ®ÿ±ÿß€å ÿØÿßŸÜÿ¥‚Äåÿ¢ŸÖŸàÿ≤Ÿáÿß ŸÇÿßÿ®ŸÑ ŸÖÿ¥ÿßŸáÿØŸá ŸÖ€å‚Äåÿ¥ŸàÿØ.</div>
                        </div>

                        {{-- Actions --}}
                        <div class="col-12 d-flex flex-wrap gap-2 mt-2">
                            <button type="submit" class="btn btn-primary btn-wizard shadow-sm">
                                <i class="bi bi-save2"></i>
                                ÿ∞ÿÆ€åÿ±Ÿá ÿ™ÿ∫€å€åÿ±ÿßÿ™
                            </button>
                            <a href="{{ route('teacher.exams.questions.index', $exam) }}"
                               class="btn btn-outline-primary btn-wizard shadow-sm">
                                <i class="bi bi-question-circle"></i>
                                ÿ±ŸÅÿ™ŸÜ ÿ®Ÿá ÿ≥ŸàÿßŸÑ‚ÄåŸáÿß
                            </a>
                        </div>

                    </form>

                    {{-- Danger zone --}}
                    <div class="danger-zone p-3 mt-4">
                        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                            <div>
                                <div class="fw-bold text-danger">
                                    <i class="bi bi-trash3 me-1"></i> ÿ≠ÿ∞ŸÅ ÿ¢ÿ≤ŸÖŸàŸÜ
                                </div>
                                <div class="small text-muted">ÿß€åŸÜ ÿπŸÖŸÑ€åÿßÿ™ ÿ∫€åÿ±ŸÇÿßÿ®ŸÑ ÿ®ÿßÿ≤⁄Øÿ¥ÿ™ ÿßÿ≥ÿ™.</div>
                            </div>
                            <form action="{{ route('teacher.exams.destroy', $exam) }}" method="POST">
                                @csrf
                                @method('DELETE')
                                <button class="btn btn-outline-danger btn-wizard"
                                        onclick="return confirm('ÿ¢€åÿß ÿßÿ≤ ÿ≠ÿ∞ŸÅ ÿ¢ÿ≤ŸÖŸàŸÜ ŸÖÿ∑ŸÖÿ¶ŸÜ Ÿáÿ≥ÿ™€åÿØÿü')">
                                    ÿ≠ÿ∞ŸÅ ŸÇÿ∑ÿπ€å
                                </button>
                            </form>
                        </div>
                    </div>

                </div>
            </div>

            {{-- Preview / tips column --}}
            <div class="col-lg-4">
                <div class="floating-help fade-up">

                    <div class="preview-card p-3 mb-3">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <div class="fw-bold">
                                <i class="bi bi-eye me-1"></i> Ÿæ€åÿ¥‚ÄåŸÜŸÖÿß€åÿ¥ ÿ≥ÿ±€åÿπ
                            </div>
                            <span class="badge preview-badge">Live</span>
                        </div>
                        <div class="small text-muted mb-2">ÿ®ÿß ÿ™ÿ∫€å€åÿ± ŸÅÿ±ŸÖÿå ÿß€åŸÜ ⁄©ÿßÿ±ÿ™ ÿ¢ŸæÿØ€åÿ™ ŸÖ€å‚Äåÿ¥ŸàÿØ.</div>

                        <div class="border rounded-3 p-3 bg-white" id="livePreview">
                            <div class="fw-semibold" id="pvTitle">{{ $exam->title }}</div>
                            <div class="text-muted small mt-1" id="pvMeta">
                                {{ $exam->level }} ‚Ä¢ {{ $exam->subject }} ‚Ä¢ {{ $exam->duration_minutes }} ÿØŸÇ€åŸÇŸá
                            </div>
                            <div class="text-muted small mt-2" id="pvStart">
                                ÿ¥ÿ±Ÿàÿπ: {{ optional($exam->start_at)->format('Y/m/d H:i') }}
                            </div>
                            <div class="mt-2">
                                @if ($exam->is_published)
                                    <span class="badge bg-success">
                                        <i class="bi bi-broadcast-pin me-1"></i> ŸÖŸÜÿ™ÿ¥ÿ± ÿ¥ÿØŸá
                                    </span>
                                @else
                                    <span class="badge bg-secondary">
                                        <i class="bi bi-pencil-square me-1"></i> Ÿæ€åÿ¥‚ÄåŸÜŸà€åÿ≥
                                    </span>
                                @endif
                            </div>
                        </div>
                    </div>

                    <div class="form-card p-3">
                        <div class="fw-bold mb-2">
                            <i class="bi bi-lightbulb me-1 text-warning"></i> Ÿæ€åÿ¥ŸÜŸáÿßÿØŸáÿß€å ÿ®Ÿáÿ®ŸàÿØ
                        </div>
                        <ul class="small text-muted mb-0 ps-3">
                            <li>ŸÇÿ®ŸÑ ÿßÿ≤ ÿßŸÜÿ™ÿ¥ÿßÿ±ÿå ÿ≠ÿØÿßŸÇŸÑ €µ ÿ≥ÿ§ÿßŸÑ ÿßÿ∂ÿßŸÅŸá ⁄©ŸÜ.</li>
                            <li>ÿß⁄Øÿ± ÿ≤ŸÖÿßŸÜ ÿ®ÿ±⁄Øÿ≤ÿßÿ±€å ÿ™ÿ∫€å€åÿ± ⁄©ÿ±ÿØÿå ÿßÿ∑ŸÑÿßÿπ€åŸá ÿ®ŸÅÿ±ÿ≥ÿ™.</li>
                            <li>ŸÖ€å‚Äåÿ™ŸàÿßŸÜ€å ÿ®ÿπÿØÿßŸã ŸÖÿØÿ™ Ÿà ÿ≥ÿ∑ÿ≠ ÿ±ÿß ÿßÿµŸÑÿßÿ≠ ⁄©ŸÜ€å.</li>
                        </ul>
                    </div>

                </div>
            </div>

        </div>
    </div>

    @push('scripts')
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const title = document.querySelector('input[name="title"]');
                const subject = document.querySelector('select[name="subject"]');
                const level = document.querySelector('select[name="level"]');
                const duration = document.querySelector('input[name="duration"]');
                const startAt = document.querySelector('input[name="start_at"]');

                const pvTitle = document.getElementById('pvTitle');
                const pvMeta = document.getElementById('pvMeta');
                const pvStart = document.getElementById('pvStart');

                function updatePreview() {
                    if (pvTitle) pvTitle.textContent = title?.value?.trim() || 'ÿπŸÜŸàÿßŸÜ ÿ¢ÿ≤ŸÖŸàŸÜ';
                    const s = subject?.value || 'ÿØÿ±ÿ≥';
                    const l = level?.value || 'ÿ≥ÿ∑ÿ≠';
                    const d = duration?.value || '‚Äî';
                    if (pvMeta) pvMeta.textContent = `${l} ‚Ä¢ ${s} ‚Ä¢ ${d} ÿØŸÇ€åŸÇŸá`;
                    if (pvStart) pvStart.textContent = startAt?.value
                        ? `ÿ¥ÿ±Ÿàÿπ: ${startAt.value.replace('T', ' ')}`
                        : 'ÿ≤ŸÖÿßŸÜ ÿ¥ÿ±Ÿàÿπ';
                }

                [title, subject, level, duration, startAt].forEach(el =>
                    el?.addEventListener('input', updatePreview)
                );
                updatePreview();
            });

            // toggle classroom box
            const editScopeFree = document.getElementById('editScopeFree');
            const editScopeClassroom = document.getElementById('editScopeClassroom');
            const editClassroomBox = document.getElementById('editClassroomBox');
            const editClassroomSelect = editClassroomBox?.querySelector('select[name="classroom_id"]');

            function toggleEditClassroom() {
                const isFree = editScopeFree?.checked;
                if (editClassroomBox) editClassroomBox.style.display = isFree ? 'none' : 'block';
                if (editClassroomSelect) editClassroomSelect.required = !isFree;
            }

            editScopeFree?.addEventListener('change', toggleEditClassroom);
            editScopeClassroom?.addEventListener('change', toggleEditClassroom);
            toggleEditClassroom();
        </script>
    @endpush
@endsection


==================== FILE: public/assets/js/exam-wizard.js ====================
/* ===========================================================
 * exam-wizard.js (UUID + AJAX Real Data)
 * ÿ≥ÿßÿ≤⁄Øÿßÿ± ÿ®ÿß routes/teacher.php Ÿà TeacherExamController
 * ŸÜÿ≥ÿÆŸá ŸÜŸáÿß€å€å (ŸÖŸÜÿ∑ŸÇ 3 ÿ≠ÿßŸÑÿ™Ÿá + Ÿæÿ±ÿ¥ + FIX branches)
 * + FIX default examType from hidden
 * + FIX subjects title_fa/name_fa mismatch
 * =========================================================== */

let currentStep = 1;

const endpoint = {
  sections: "/dashboard/teacher/exams/data/sections",
  grades: "/dashboard/teacher/exams/data/grades",
  branches: "/dashboard/teacher/exams/data/branches",
  fields: "/dashboard/teacher/exams/data/fields",
  subfields: "/dashboard/teacher/exams/data/subfields",
  subjectTypes: "/dashboard/teacher/exams/data/subject-types",
  subjects: "/dashboard/teacher/exams/data/subjects",
  classMeta: (id) => `/dashboard/teacher/classes/${id}/meta`,
  classesAjax: "/dashboard/teacher/classes?ajax=1",
};

// UI Names (preview)
const examTypeNames = {
  public: "ÿ¢ÿ≤ŸÖŸàŸÜ ÿπŸÖŸàŸÖ€å",
  class_single: "⁄©ŸÑÿßÿ≥€å ÿ™⁄© ÿØÿ±ÿ≥",
  class_comprehensive: "⁄©ŸÑÿßÿ≥€å ÿ¨ÿßŸÖÿπ",
};

const subjectTypeFallbackNames = {
  base_competency: "ÿ¥ÿß€åÿ≥ÿ™⁄Ø€å Ÿæÿß€åŸá",
  non_technical_competency: "ÿ¥ÿß€åÿ≥ÿ™⁄Ø€å ÿ∫€åÿ±ŸÅŸÜ€å",
  technical_competency: "ÿ¥ÿß€åÿ≥ÿ™⁄Ø€å ŸÅŸÜ€å",
  general: "ÿØÿ±Ÿàÿ≥ ÿπŸÖŸàŸÖ€å",
  all: "ŸáŸÖŸá ÿØÿ±Ÿàÿ≥",
  specialized_competency: "ÿ¥ÿß€åÿ≥ÿ™⁄Ø€å‚ÄåŸáÿß€å ÿ™ÿÆÿµÿµ€å",
};

// state
let formData = {
  examType: "",
  classroomId: null,
  classroomName: "",

  sectionId: "",
  sectionName: "",

  gradeId: "",
  gradeName: "",

  branchId: "",
  branchName: "",

  fieldId: "",
  fieldName: "",

  subfieldId: "",
  subfieldName: "",

  subjectTypeId: "",
  subjectTypeSlug: "",
  subjectTypeName: "",

  selectedSubjects: [], // UUID[]
  totalQuestions: 0,
};

/* ===================== helpers ===================== */

const qs = (sel) => document.querySelector(sel);
const qsa = (sel) => Array.from(document.querySelectorAll(sel));

const csrf = () =>
  document.querySelector('meta[name="csrf-token"]')?.content || "";

function setHidden(id, val) {
  const el = qs(id);
  if (el) el.value = val ?? "";
}

function showToast(message, icon = "error") {
  if (typeof Swal === "undefined") {
    alert(message);
    return;
  }
  Swal.fire({
    toast: true,
    position: "top-start",
    icon,
    title: message,
    showConfirmButton: false,
    timer: 2500,
    timerProgressBar: true,
  });
}

async function getJSON(url) {
  const res = await fetch(url, {
    headers: {
      Accept: "application/json",
      "X-Requested-With": "XMLHttpRequest",
    },
  });
  if (!res.ok) throw new Error("Network error");
  return res.json();
}

/* ===================== init ===================== */

document.addEventListener("DOMContentLoaded", () => {
  updateProgress();
  updateNavigationButtons();
  loadFromLocalStorage();

  // ‚úÖ ÿß⁄Øÿ± classroom_id ÿßÿ≤ Blade/URL ÿ¢ŸÖÿØŸá Ÿà ŸÇÿ®ŸÑÿßŸã ÿßŸÜÿ™ÿÆÿßÿ® ŸÜÿ¥ÿØŸá
  const preClassId = qs("#classroomId")?.value;
  if (!formData.classroomId && preClassId) {
    formData.classroomId = preClassId;
    setHidden("#classroomId", preClassId);
  }

  // ‚úÖ FIX ŸÖŸáŸÖ: examType Ÿæ€åÿ¥‚ÄåŸÅÿ±ÿ∂ ÿßÿ≤ hidden ÿ®⁄Ø€åÿ±
  const preType = qs("#examType")?.value; // ŸÖÿ´ŸÑÿß public
  if (!formData.examType && preType) {
    // ÿ®ÿØŸàŸÜ Ÿæÿß⁄©‚Äåÿ≥ÿßÿ≤€å stateÿå ŸÅŸÇÿ∑ ŸáŸÖ⁄ØÿßŸÖ‚Äåÿ≥ÿßÿ≤€å Ÿà ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ÿßÿ±ÿ™
    formData.examType = preType;
    qsa(".type-card").forEach((c) => c.classList.remove("selected"));
    qs(`.type-card[data-type="${preType}"]`)?.classList.add("selected");

    if (preType === "public") {
      showClassroomSection(false);
      enableNext(true);
    } else {
      showClassroomSection(true);
      loadExistingClassrooms();
      enableNext(!!formData.classroomId);
    }
    updatePreview();
    saveToLocalStorage();
  }

  // ÿß⁄Øÿ± ÿßÿ≤ ŸÇÿ®ŸÑ examType ÿßŸÜÿ™ÿÆÿßÿ® ÿ¥ÿØŸá ÿ®ŸàÿØ Ÿà ⁄©ŸÑÿßÿ≥€å ÿ®ŸàÿØ ⁄©ŸÑÿßÿ≥‚ÄåŸáÿß ÿ±Ÿà ŸÑŸàÿØ ⁄©ŸÜ
  if (formData.examType && formData.examType !== "public") {
    showClassroomSection(true);
    loadExistingClassrooms();
  }

  updateExamTypeIndicator?.();
});

/* ===================== step 1 exam type ===================== */

window.selectExamType = function (type) {
  qsa(".type-card").forEach((c) => c.classList.remove("selected"));
  qs(`.type-card[data-type="${type}"]`)?.classList.add("selected");

  formData.examType = type;
  setHidden("#examType", type);

  if (type === "public") {
    showClassroomSection(false);

    formData.classroomId = null;
    formData.classroomName = "";
    setHidden("#classroomId", "");

    enableNext(true);
  } else {
    showClassroomSection(true);
    loadExistingClassrooms();
    enableNext(false);
  }

  updateExamTypeIndicator?.();
  updatePreview();
  saveToLocalStorage();
};

function showClassroomSection(show) {
  const sec = qs("#classroomSelectionSection");
  if (!sec) return;
  sec.style.display = show ? "block" : "none";
}

function enableNext(enable) {
  const btn = qs(".btn-next");
  if (!btn) return;
  btn.disabled = !enable;
  btn.classList.toggle("disabled", !enable);
}

/* -------- load classrooms (UUID) -------- */

window.loadExistingClassrooms = async function () {
  const container = qs("#existingClassroomsContainer");
  if (!container) return;

  container.innerHTML = `
    <div class="loading-spinner" style="grid-column: 1 / -1; text-align:center; padding:20px;">
      <i class="fas fa-spinner fa-spin"></i>
      ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ⁄©ŸÑÿßÿ≥‚ÄåŸáÿß...
    </div>
  `;

  try {
    const data = await getJSON(endpoint.classesAjax);

    container.innerHTML = "";

    const classes = data.classrooms || [];
    if (classes.length === 0) {
      container.innerHTML = `
        <div style="grid-column: 1 / -1; text-align:center; padding:20px; color:#777;">
          ⁄©ŸÑÿßÿ≥€å €åÿßŸÅÿ™ ŸÜÿ¥ÿØ. ŸÑÿ∑ŸÅÿßŸã ⁄©ŸÑÿßÿ≥ ÿ¨ÿØ€åÿØ ÿ®ÿ≥ÿßÿ≤€åÿØ.
        </div>
      `;
      return;
    }

    classes.forEach((classroom) => {
      const card = document.createElement("div");
      card.className = "selection-card";
      card.dataset.classroomId = classroom.id;
      card.innerHTML = `
        <div class="selection-icon">üè´</div>
        <div class="selection-name">${classroom.title}</div>
        <p class="selection-description">
          <small>${classroom.grade || "ÿ®ÿØŸàŸÜ Ÿæÿß€åŸá"} - ${classroom.subject || "ÿ®ÿØŸàŸÜ ŸÖŸàÿ∂Ÿàÿπ"}</small>
          <br><strong>${classroom.students_count || 0} ŸáŸÜÿ±ÿ¨Ÿà</strong>
        </p>
      `;
      card.onclick = (e) => selectClassroom(e, classroom.id, classroom.title);
      container.appendChild(card);
    });

    if (formData.classroomId) {
      container
        .querySelector(`[data-classroom-id="${formData.classroomId}"]`)
        ?.classList.add("selected");
      enableNext(true);
    }
  } catch (err) {
    console.error(err);
    container.innerHTML = `
      <div style="grid-column: 1 / -1; text-align:center; padding:20px; color:#e67;">
        ÿÆÿ∑ÿß ÿØÿ± ÿØÿ±€åÿßŸÅÿ™ ⁄©ŸÑÿßÿ≥‚ÄåŸáÿß
        <br>
        <button type="button" onclick="loadExistingClassrooms()" class="btn-nav" style="padding:10px 20px; margin-top:15px;">ÿ™ŸÑÿßÿ¥ ŸÖÿ¨ÿØÿØ</button>
      </div>
    `;
  }
};

/* -------- select classroom + auto-fill meta -------- */

window.selectClassroom = async function (e, classroomId, classroomName) {
  qsa("#existingClassroomsContainer .selection-card").forEach((c) =>
    c.classList.remove("selected")
  );
  e?.target?.closest(".selection-card")?.classList.add("selected");

  formData.classroomId = classroomId;
  formData.classroomName = classroomName;
  setHidden("#classroomId", classroomId);

  try {
    const metaData = await getJSON(endpoint.classMeta(classroomId));
    const meta = metaData.classroom || {};

    if (meta.section_id) {
      formData.sectionId = meta.section_id;
      setHidden("#sectionId", meta.section_id);
    }

    if (meta.grade_id) {
      formData.gradeId = meta.grade_id;
      setHidden("#gradeId", meta.grade_id);
    }

    if (meta.branch_id) {
      formData.branchId = meta.branch_id;
      setHidden("#branchId", meta.branch_id);
    }

    if (meta.field_id) {
      formData.fieldId = meta.field_id;
      setHidden("#fieldId", meta.field_id);
    }

    if (meta.subfield_id) {
      formData.subfieldId = meta.subfield_id;
      setHidden("#subfieldId", meta.subfield_id);
    }

    if (formData.examType === "class_single" && meta.subject_id) {
      formData.selectedSubjects = [meta.subject_id];
      setHidden("#subjectsInput", JSON.stringify(formData.selectedSubjects));
    }

    if (formData.examType === "class_comprehensive") {
      formData.subjectTypeSlug = "all";
      formData.subjectTypeName = subjectTypeFallbackNames.all;
      formData.subjectTypeId = "";
      setHidden("#subjectTypeId", "");
      calculateCoefficients("all");

      try {
        await loadSubjectsForAllAndSave();
      } catch (e) {
        console.error("auto all subjects error", e);
      }
    }
  } catch (err) {
    console.error("class meta error", err);
  }

  enableNext(true);
  updatePreview();
  saveToLocalStorage();

  if (
    formData.examType === "class_single" ||
    formData.examType === "class_comprehensive"
  ) {
    jumpToStep(8);
  } else {
    nextStep();
  }
};

/* ===================== step 2 grades ===================== */

async function loadGrades() {
  const container = qs("#gradesGrid");
  if (!container) return;

  container.innerHTML = `<div class="loading-spinner" style="grid-column:1/-1;text-align:center;">ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å...</div>`;

  const params = new URLSearchParams();
  if (formData.sectionId) params.append("section_id", formData.sectionId);

  const data = await getJSON(`${endpoint.grades}?${params.toString()}`);

  container.innerHTML = "";
  (data.grades || []).forEach((g) => {
    const card = document.createElement("div");
    card.className = "selection-card";
    card.dataset.id = g.id;
    card.innerHTML = `
      <div class="selection-icon">üìò</div>
      <div class="selection-name">${g.name_fa}</div>
      <p class="selection-description">${g.slug || ""}</p>
    `;
    card.onclick = (e) => selectGrade(e, g.id, g.name_fa);
    container.appendChild(card);
  });

  if (formData.gradeId) {
    container
      .querySelector(`[data-id="${formData.gradeId}"]`)
      ?.classList.add("selected");
  }
}

window.selectGrade = function (e, gradeId, gradeName) {
  qsa("#gradesGrid .selection-card").forEach((c) =>
    c.classList.remove("selected")
  );
  e?.target?.closest(".selection-card")?.classList.add("selected");

  formData.gradeId = gradeId;
  formData.gradeName = gradeName;
  setHidden("#gradeId", gradeId);

  formData.branchId = "";
  formData.branchName = "";
  setHidden("#branchId", "");

  formData.fieldId = "";
  formData.fieldName = "";
  setHidden("#fieldId", "");

  formData.subfieldId = "";
  formData.subfieldName = "";
  setHidden("#subfieldId", "");

  formData.subjectTypeId = "";
  formData.subjectTypeSlug = "";
  formData.subjectTypeName = "";
  setHidden("#subjectTypeId", "");

  formData.selectedSubjects = [];
  setHidden("#subjectsInput", JSON.stringify([]));

  updatePreview();
  saveToLocalStorage();
};

/* ===================== step 3 branches (FIXED) ===================== */

async function loadBranches() {
  const container = qs("#branchesGrid");
  if (!container) return;

  container.innerHTML =
    `<div class="loading-spinner" style="grid-column:1/-1;text-align:center;">
        ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å...
     </div>`;

  const params = new URLSearchParams();
  if (formData.sectionId) params.append("section_id", formData.sectionId);
  if (formData.gradeId) params.append("grade_id", formData.gradeId);

  try {
    const data = await getJSON(`${endpoint.branches}?${params.toString()}`);

    container.innerHTML = "";
    (data.branches || []).forEach((b) => {
      const card = document.createElement("div");
      card.className = "selection-card";
      card.dataset.id = b.id;
      card.innerHTML = `
        <div class="selection-icon">üéì</div>
        <div class="selection-name">${b.name_fa}</div>
        <p class="selection-description">${b.slug || ""}</p>
      `;
      card.onclick = (e) => selectBranch(e, b.id, b.name_fa);
      container.appendChild(card);
    });

    if (formData.branchId) {
      container
        .querySelector(`[data-id="${formData.branchId}"]`)
        ?.classList.add("selected");
    }
  } catch (err) {
    console.error(err);
    container.innerHTML = `
      <div class="alert alert-danger text-center" style="grid-column:1/-1;">
        ÿÆÿ∑ÿß ÿØÿ± ÿØÿ±€åÿßŸÅÿ™ ÿ¥ÿßÿÆŸá‚ÄåŸáÿß. ŸÑÿ∑ŸÅÿßŸã ÿØŸàÿ®ÿßÿ±Ÿá ÿ™ŸÑÿßÿ¥ ⁄©ŸÜ€åÿØ.
        <br>
        <button type="button"
                class="btn-nav btn-prev"
                style="margin-top:12px;border-color:var(--primary);color:var(--primary);"
                onclick="loadBranches()">
          ÿ™ŸÑÿßÿ¥ ŸÖÿ¨ÿØÿØ
        </button>
      </div>
    `;
  }
}

window.selectBranch = function (e, branchId, branchName) {
  qsa("#branchesGrid .selection-card").forEach((c) =>
    c.classList.remove("selected")
  );
  e?.target?.closest(".selection-card")?.classList.add("selected");

  formData.branchId = branchId;
  formData.branchName = branchName;
  setHidden("#branchId", branchId);

  formData.fieldId = "";
  formData.fieldName = "";
  setHidden("#fieldId", "");

  formData.subfieldId = "";
  formData.subfieldName = "";
  setHidden("#subfieldId", "");

  formData.subjectTypeId = "";
  formData.subjectTypeSlug = "";
  formData.subjectTypeName = "";
  setHidden("#subjectTypeId", "");

  formData.selectedSubjects = [];
  setHidden("#subjectsInput", JSON.stringify([]));

  updatePreview();
  saveToLocalStorage();
};

/* ===================== step 4 fields ===================== */

async function loadFields() {
  const container = qs("#fieldsGrid");
  if (!container) return;

  container.innerHTML = `<div class="loading-spinner" style="grid-column:1/-1;text-align:center;">ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å...</div>`;

  const params = new URLSearchParams();
  if (formData.branchId) params.append("branch_id", formData.branchId);

  const data = await getJSON(`${endpoint.fields}?${params.toString()}`);

  container.innerHTML = "";
  (data.fields || []).forEach((f) => {
    const card = document.createElement("div");
    card.className = "selection-card";
    card.dataset.id = f.id;
    card.innerHTML = `
      <div class="selection-icon">üè≠</div>
      <div class="selection-name">${f.name_fa}</div>
      <p class="selection-description">${f.slug || ""}</p>
    `;
    card.onclick = (e) => selectField(e, f.id, f.name_fa);
    container.appendChild(card);
  });

  if (formData.fieldId) {
    container
      .querySelector(`[data-id="${formData.fieldId}"]`)
      ?.classList.add("selected");
  }
}

window.selectField = function (e, fieldId, fieldName) {
  qsa("#fieldsGrid .selection-card").forEach((c) =>
    c.classList.remove("selected")
  );
  e?.target?.closest(".selection-card")?.classList.add("selected");

  formData.fieldId = fieldId;
  formData.fieldName = fieldName;
  setHidden("#fieldId", fieldId);

  formData.subfieldId = "";
  formData.subfieldName = "";
  setHidden("#subfieldId", "");

  formData.subjectTypeId = "";
  formData.subjectTypeSlug = "";
  formData.subjectTypeName = "";
  setHidden("#subjectTypeId", "");

  formData.selectedSubjects = [];
  setHidden("#subjectsInput", JSON.stringify([]));

  updatePreview();
  saveToLocalStorage();
};

/* ===================== step 5 subfields ===================== */

async function loadSubfields() {
  const container = qs("#subfieldGrid");
  if (!container) return;

  container.innerHTML = `<div class="loading-spinner" style="grid-column:1/-1;text-align:center;">ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å...</div>`;

  const params = new URLSearchParams();
  if (formData.fieldId) params.append("field_id", formData.fieldId);

  const data = await getJSON(`${endpoint.subfields}?${params.toString()}`);

  container.innerHTML = "";
  (data.subfields || []).forEach((s) => {
    const card = document.createElement("div");
    card.className = "selection-card";
    card.dataset.id = s.id;
    card.innerHTML = `
      <div class="selection-icon">üî¨</div>
      <div class="selection-name">${s.name_fa}</div>
      <p class="selection-description">${s.slug || ""}</p>
    `;
    card.onclick = (e) => selectSubfield(e, s.id, s.name_fa);
    container.appendChild(card);
  });

  if (formData.subfieldId) {
    container
      .querySelector(`[data-id="${formData.subfieldId}"]`)
      ?.classList.add("selected");
  }
}

window.selectSubfield = function (e, subfieldId, subfieldName) {
  qsa("#subfieldGrid .selection-card").forEach((c) =>
    c.classList.remove("selected")
  );
  e?.target?.closest(".selection-card")?.classList.add("selected");

  formData.subfieldId = subfieldId;
  formData.subfieldName = subfieldName;
  setHidden("#subfieldId", subfieldId);

  updatePreview();
  saveToLocalStorage();
};
/* ===================== step 6 subject types (FIXED like branches) ===================== */
/* ===================== step 6 subject types (FIX like branches) ===================== */

const subjectTypeMetaMap = {
  // slugs ŸàÿßŸÇÿπ€å DB ÿ¥ŸÖÿß
  DSHP: { name: "ÿ¥ÿß€åÿ≥ÿ™⁄Ø€å Ÿæÿß€åŸá", questions: 35 },
  DSHGHF: { name: "ÿ¥ÿß€åÿ≥ÿ™⁄Ø€å ÿ∫€åÿ±ŸÅŸÜ€å", questions: 20 },
  DSHF: { name: "ÿ¥ÿß€åÿ≥ÿ™⁄Ø€å ŸÅŸÜ€å", questions: 60 },

  // slugs ÿßÿ≥ÿ™ÿßŸÜÿØÿßÿ±ÿØ ŸÇÿ®ŸÑ€å (ÿ®ÿ±ÿß€å ÿ≥ÿßÿ≤⁄Øÿßÿ±€å)
  base_competency: { name: "ÿ¥ÿß€åÿ≥ÿ™⁄Ø€å Ÿæÿß€åŸá", questions: 35 },
  non_technical_competency: { name: "ÿ¥ÿß€åÿ≥ÿ™⁄Ø€å ÿ∫€åÿ±ŸÅŸÜ€å", questions: 20 },
  technical_competency: { name: "ÿ¥ÿß€åÿ≥ÿ™⁄Ø€å ŸÅŸÜ€å", questions: 60 },

  general: { name: "ÿØÿ±Ÿàÿ≥ ÿπŸÖŸàŸÖ€å", questions: 0 },
  specialized_competency: { name: "ÿ¥ÿß€åÿ≥ÿ™⁄Ø€å‚ÄåŸáÿß€å ÿ™ÿÆÿµÿµ€å", questions: 0 },
  all: { name: "ŸáŸÖŸá ÿØÿ±Ÿàÿ≥", questions: 115 },
};

function getSubjectTypeMeta(slug) {
  return subjectTypeMetaMap[slug] || { name: slug || "--", questions: 0 };
}

async function loadSubjectTypes() {
  const container = qs("#subjectTypesGrid");
  if (!container) return;

  container.innerHTML = `
    <div class="loading-spinner" style="grid-column:1/-1;text-align:center;">
      ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å...
    </div>
  `;

  // ŸÖÿ´ŸÑ branches: Ÿæÿßÿ±ÿßŸÖÿ™ÿ±Ÿáÿß ÿ±Ÿà ÿØŸÇ€åŸÇ Ÿà ŸÖÿ±ÿ≠ŸÑŸá‚Äåÿß€å ŸÖ€å‚Äåÿ≥ÿßÿ≤€åŸÖ
  const params = new URLSearchParams();
  if (formData.sectionId) params.append("section_id", formData.sectionId);
  if (formData.gradeId) params.append("grade_id", formData.gradeId);
  if (formData.branchId) params.append("branch_id", formData.branchId);
  if (formData.fieldId) params.append("field_id", formData.fieldId);
  if (formData.subfieldId) params.append("subfield_id", formData.subfieldId);

  const urlWithParams = `${endpoint.subjectTypes}?${params.toString()}`;
  const urlNoParams = `${endpoint.subjectTypes}`;

  try {
    // 1) ÿßŸàŸÑ ÿ®ÿß ŸÅ€åŸÑÿ™ÿ±Ÿáÿß ÿßŸÖÿ™ÿ≠ÿßŸÜ ⁄©ŸÜ
    let data;
    try {
      data = await getJSON(urlWithParams);
    } catch (e) {
      // 2) ÿß⁄Øÿ± ŸÖÿ´ŸÑ ÿ¥ÿßÿÆŸá‚ÄåŸáÿß backend ÿ®ÿß ŸÅ€åŸÑÿ™ÿ±Ÿáÿß ÿÆÿ∑ÿß ÿØÿßÿØÿå ÿ®ÿØŸàŸÜ ŸÅ€åŸÑÿ™ÿ± ÿØŸàÿ®ÿßÿ±Ÿá ÿ®⁄Ø€åÿ±
      console.warn("subject-types with params failed, retrying without params", e);
      data = await getJSON(urlNoParams);
    }

    container.innerHTML = "";
    const list = data.subject_types || data.subjectTypes || [];

    if (list.length === 0) {
      container.innerHTML = `
        <div class="alert alert-info text-center" style="grid-column:1/-1;">
          ÿØÿ≥ÿ™Ÿá ÿØÿ±ÿ≥€å ÿ®ÿ±ÿß€å ÿßŸÜÿ™ÿÆÿßÿ®‚ÄåŸáÿß€å ÿ¥ŸÖÿß €åÿßŸÅÿ™ ŸÜÿ¥ÿØ.
        </div>
      `;
      return;
    }

    list.forEach((st) => {
      const card = document.createElement("div");
      card.className = "selection-card";
      card.dataset.slug = st.slug;

      const title = st.name_fa || getSubjectTypeMeta(st.slug).name;

      card.innerHTML = `
        <div class="selection-icon">üìö</div>
        <div class="selection-name">${title}</div>
        <p class="selection-description">${st.slug || ""}</p>
      `;
      card.onclick = (e) => selectSubjectType(e, st.id, st.slug, title);
      container.appendChild(card);
    });

    // ÿß⁄Øÿ± ŸÇÿ®ŸÑÿßŸã ÿßŸÜÿ™ÿÆÿßÿ® ÿ¥ÿØŸá ÿ®ŸàÿØ (localStorage)ÿå Ÿáÿß€åŸÑÿß€åÿ™ ÿ®ÿ±⁄Øÿ±ÿØŸá
    if (formData.subjectTypeSlug) {
      container
        .querySelector(`[data-slug="${formData.subjectTypeSlug}"]`)
        ?.classList.add("selected");
    }

  } catch (err) {
    console.error("subject types error", err);
    container.innerHTML = `
      <div class="alert alert-danger text-center" style="grid-column:1/-1;">
        ÿÆÿ∑ÿß ÿØÿ± ÿØÿ±€åÿßŸÅÿ™ ÿØÿ≥ÿ™Ÿá‚ÄåŸáÿß€å ÿØÿ±ÿ≥€å. ŸÑÿ∑ŸÅÿßŸã ÿØŸàÿ®ÿßÿ±Ÿá ÿ™ŸÑÿßÿ¥ ⁄©ŸÜ€åÿØ.
        <br>
        <button type="button"
          class="btn-nav btn-prev"
          style="margin-top:12px;border-color:var(--primary);color:var(--primary);"
          onclick="loadSubjectTypes()">
          ÿ™ŸÑÿßÿ¥ ŸÖÿ¨ÿØÿØ
        </button>
      </div>
    `;
  }
}

window.selectSubjectType = function (e, id, slug, name) {
  qsa("#subjectTypesGrid .selection-card").forEach((c) =>
    c.classList.remove("selected")
  );
  e?.target?.closest(".selection-card")?.classList.add("selected");

  formData.subjectTypeId = id;
  formData.subjectTypeSlug = slug;

  // name €åÿß ÿßÿ≤ ÿ®⁄©‚ÄåÿßŸÜÿØ €åÿß ÿßÿ≤ map
  formData.subjectTypeName = name || getSubjectTypeMeta(slug).name;

  setHidden("#subjectTypeId", id);

  calculateCoefficients(slug);
  updatePreview();
  saveToLocalStorage();
};

/* ---------- coefficient section (FIX slugs) ---------- */

function calculateCoefficients(slug) {
  const meta = getSubjectTypeMeta(slug);
  formData.totalQuestions = meta.questions || 0;

  const el = qs("#previewTotalQuestions");
  if (el) el.textContent = (formData.totalQuestions || 0) + " ÿ≥ŸàÿßŸÑ";
}

function isUuid(val) {
  return typeof val === "string" &&
    /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(val);
}

/* ===================== step 7 subjects ===================== */
async function loadSubjects() {
// ‚úÖ ÿ¢ÿÆÿ±€åŸÜ ÿÆÿ∑ ÿØŸÅÿßÿπ: ÿß⁄Øÿ± subjectTypeId ÿπÿØÿØ€å/ŸÇÿØ€åŸÖ€å ÿ®ŸàÿØÿå Ÿæÿß⁄©ÿ¥ ⁄©ŸÜ
if (formData.subjectTypeId && !isUuid(formData.subjectTypeId)) {
  console.warn("subjectTypeId was numeric, clearing it:", formData.subjectTypeId);
  formData.subjectTypeId = "";
  setHidden("#subjectTypeId", "");
  saveToLocalStorage();
}

  const container = qs("#subjectsContainer");
  if (!container) return;

  container.innerHTML =
    '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> ÿØÿ± ÿ≠ÿßŸÑ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å ÿØÿ±Ÿàÿ≥...</div>';

  const params = new URLSearchParams();

  // ‚úÖ ŸÅ€åŸÑÿ™ÿ±Ÿáÿß€å ÿßÿµŸÑ€å
  if (formData.gradeId) params.append("grade_id", formData.gradeId);
  if (formData.branchId) params.append("branch_id", formData.branchId);
  if (formData.fieldId) params.append("field_id", formData.fieldId);
  if (formData.subfieldId) params.append("subfield_id", formData.subfieldId);

  // ‚úÖ ÿ≠ÿßŸÑÿ™‚ÄåŸáÿß€å subject type
  if (formData.subjectTypeSlug === "all") {
    // Ÿá€å⁄Ü subject_type_id ŸÜŸÅÿ±ÿ≥ÿ™€åŸÖÿå ÿ®⁄©‚ÄåÿßŸÜÿØ ŸáŸÖŸá ÿ±Ÿà ÿ®ÿ±⁄Øÿ±ÿØŸàŸÜŸá
  } else if (formData.subjectTypeId) {
    params.append("subject_type_id", formData.subjectTypeId);
  } else if (formData.subjectTypeSlug) {
    // ÿß⁄Øÿ± ÿ®⁄©‚ÄåÿßŸÜÿØ slug ŸÖ€å‚ÄåŸæÿ∞€åÿ±Ÿá
    params.append("subject_type_slug", formData.subjectTypeSlug);
  }

  const url = `${endpoint.subjects}?${params.toString()}`;
  console.log("subjects url =>", url);

  try {
    const data = await getJSON(url);

    // ‚úÖ ÿßŸÜÿπÿ∑ÿßŸÅ ÿØÿ± ŸÜÿßŸÖ ⁄©ŸÑ€åÿØ ÿ¨Ÿàÿßÿ®
    const subjects =
      data.subjects ||
      data.data ||
      data.items ||
      [];

    if (!subjects.length) {
      container.innerHTML =
        '<div class="alert alert-info">Ÿá€å⁄Ü ÿØÿ±ÿ≥€å €åÿßŸÅÿ™ ŸÜÿ¥ÿØ.</div>';
      return;
    }

    displaySubjects(subjects);

  } catch (e) {
    console.error("subjects fetch error", e);
    container.innerHTML =
      '<div class="alert alert-danger">ÿÆÿ∑ÿß ÿØÿ± ÿØÿ±€åÿßŸÅÿ™ ÿØÿ±Ÿàÿ≥.</div>';
  }
}


function displaySubjects(subjects) {
  const container = qs("#subjectsContainer");
  container.innerHTML = "";

  const singleSelect =
    formData.examType === "public" || formData.examType === "class_single";

  subjects.forEach((subject) => {
    // ‚úÖ FIX: ÿ®⁄©‚ÄåÿßŸÜÿØ name_fa ŸÖ€å‚ÄåÿØŸáÿØÿå ŸÅÿ±ÿßŸÜÿ™ title_fa ŸÖ€å‚ÄåÿÆŸàÿßÿ≥ÿ™
    const title = subject.title_fa || subject.name_fa || subject.title || "--";

    const item = document.createElement("div");
    item.className = "subject-item";
    item.innerHTML = `
      <div class="subject-checkbox">
        <input type="checkbox"
               id="subject_${subject.id}"
               value="${subject.id}"
               data-single="${singleSelect ? 1 : 0}"
               onchange="updateSelectedSubjects(this)">
      </div>
      <div class="subject-info">
        <div class="subject-name">${title}</div>
        <div class="subject-meta">
          <span class="subject-code">${subject.code || "-"}</span>
          <span>${subject.hours || 0} ÿ≥ÿßÿπÿ™</span>
        </div>
      </div>
    `;
    container.appendChild(item);
  });

  if (
    formData.subjectTypeSlug === "all" ||
    formData.examType === "class_comprehensive"
  ) {
    setTimeout(() => {
      qsa(".subject-checkbox input").forEach((cb) => (cb.checked = true));
      updateSelectedSubjects();
    }, 50);
    return;
  }

  if (formData.selectedSubjects.length) {
    setTimeout(() => {
      formData.selectedSubjects.forEach((id) => {
        const el = qs(`#subject_${id}`);
        if (el) el.checked = true;
      });
      updateSelectedSubjects();
    }, 50);
  }
}

window.updateSelectedSubjects = function (changedEl = null) {
  const all = qsa(".subject-checkbox input");
  const singleSelect =
    formData.examType === "public" || formData.examType === "class_single";

  if (singleSelect && changedEl && changedEl.checked) {
    all.forEach((cb) => {
      if (cb !== changedEl) cb.checked = false;
    });
  }

  const checked = all.filter((cb) => cb.checked);
  formData.selectedSubjects = checked.map((cb) => cb.value);

  setHidden("#subjectsInput", JSON.stringify(formData.selectedSubjects));

  const countEl = qs("#previewSubjectsCount");
  if (countEl) {
    countEl.textContent = formData.selectedSubjects.length
      ? formData.selectedSubjects.length + " ÿØÿ±ÿ≥"
      : "--";
  }

  saveToLocalStorage();
};

/* ===================== step 8 preview ===================== */

function updatePreview() {
  qs("#previewExamType") &&
    (qs("#previewExamType").textContent =
      examTypeNames[formData.examType] || "--");

  qs("#previewGrade") &&
    (qs("#previewGrade").textContent = formData.gradeName || "--");

  qs("#previewBranch") &&
    (qs("#previewBranch").textContent = formData.branchName || "--");

  qs("#previewField") &&
    (qs("#previewField").textContent = formData.fieldName || "--");

  qs("#previewSubfield") &&
    (qs("#previewSubfield").textContent = formData.subfieldName || "--");

  qs("#previewSubjectType") &&
    (qs("#previewSubjectType").textContent =
      formData.subjectTypeName ||
      subjectTypeFallbackNames[formData.subjectTypeSlug] ||
      "--");

  qs("#previewSubjectsCount") &&
    (qs("#previewSubjectsCount").textContent =
      formData.selectedSubjects.length
        ? formData.selectedSubjects.length + " ÿØÿ±ÿ≥"
        : "--");
}

/* ===================== navigation ===================== */

window.nextStep = function () {
  if (!validateCurrentStep()) return;

  if (currentStep < 8) {
    qs(`#step${currentStep}`)?.classList.remove("active");
    currentStep++;
    qs(`#step${currentStep}`)?.classList.add("active");

    handleStepChange();
    updateProgress();
    updateNavigationButtons();
    updatePreview();
    saveToLocalStorage();

    window.scrollTo({ top: 0, behavior: "smooth" });
  }
};

window.prevStep = function () {
  if (currentStep > 1) {
    qs(`#step${currentStep}`)?.classList.remove("active");
    currentStep--;
    qs(`#step${currentStep}`)?.classList.add("active");

    handleStepChange();
    updateProgress();
    updateNavigationButtons();
    updatePreview();
    saveToLocalStorage();

    window.scrollTo({ top: 0, behavior: "smooth" });
  }
};

function handleStepChange() {
  if (currentStep === 2) loadGrades();
  if (currentStep === 3) loadBranches();
  if (currentStep === 4) loadFields();
  if (currentStep === 5) loadSubfields();
  if (currentStep === 6) loadSubjectTypes();
  if (currentStep === 7) loadSubjects();
}

/* ===================== validation ===================== */

function validateCurrentStep() {
  let ok = true;
  let msg = "";

  switch (currentStep) {
    case 1:
      if (!formData.examType) {
        ok = false;
        msg = "ŸÑÿ∑ŸÅÿßŸã ŸÜŸàÿπ ÿ¢ÿ≤ŸÖŸàŸÜ ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ.";
      }
      if (formData.examType !== "public" && !formData.classroomId) {
        ok = false;
        msg = "ŸÑÿ∑ŸÅÿßŸã €å⁄© ⁄©ŸÑÿßÿ≥ ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ.";
      }
      break;

    case 2:
      if (!formData.gradeId) {
        ok = false;
        msg = "ŸÑÿ∑ŸÅÿßŸã Ÿæÿß€åŸá ÿ™ÿ≠ÿµ€åŸÑ€å ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ.";
      }
      break;

    case 3:
      if (!formData.branchId) {
        ok = false;
        msg = "ŸÑÿ∑ŸÅÿßŸã ÿ¥ÿßÿÆŸá ÿ™ÿ≠ÿµ€åŸÑ€å ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ.";
      }
      break;

    case 4:
      if (!formData.fieldId) {
        ok = false;
        msg = "ŸÑÿ∑ŸÅÿßŸã ÿ≤ŸÖ€åŸÜŸá ŸÅŸÜ€å ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ.";
      }
      break;

    case 5:
      if (!formData.subfieldId) {
        ok = false;
        msg = "ŸÑÿ∑ŸÅÿßŸã ÿ≤€åÿ±ÿ±ÿ¥ÿ™Ÿá ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ.";
      }
      break;

    case 6:
      if (!formData.subjectTypeSlug && !formData.subjectTypeId) {
        ok = false;
        msg = "ŸÑÿ∑ŸÅÿßŸã ÿØÿ≥ÿ™Ÿá ÿØÿ±ÿ≥€å ÿ±ÿß ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ.";
      }
      break;

    case 7:
      if (
        formData.selectedSubjects.length === 0 &&
        formData.subjectTypeSlug !== "all"
      ) {
        ok = false;
        msg = "ŸÑÿ∑ŸÅÿßŸã ÿ≠ÿØÿßŸÇŸÑ €å⁄© ÿØÿ±ÿ≥ ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ.";
      }
      break;
  }

  if (!ok && msg) showToast(msg, "error");
  return ok;
}

window.validateFinalStep = function () {
  if (
    !formData.examType ||
    !formData.gradeId ||
    !formData.branchId ||
    !formData.fieldId ||
    !formData.subfieldId ||
    (!formData.subjectTypeSlug && !formData.subjectTypeId)
  ) {
    showToast("ŸÑÿ∑ŸÅÿßŸã ÿ™ŸÖÿßŸÖ ŸÖÿ±ÿßÿ≠ŸÑ ÿ±ÿß ÿ™⁄©ŸÖ€åŸÑ ⁄©ŸÜ€åÿØ.", "error");
    return false;
  }

  if (
    formData.selectedSubjects.length === 0 &&
    formData.subjectTypeSlug !== "all"
  ) {
    showToast("ŸÑÿ∑ŸÅÿßŸã ÿ≠ÿØÿßŸÇŸÑ €å⁄© ÿØÿ±ÿ≥ ÿßŸÜÿ™ÿÆÿßÿ® ⁄©ŸÜ€åÿØ.", "error");
    return false;
  }

  localStorage.removeItem("examFormData");
  localStorage.removeItem("examCurrentStep");
  return true;
};

/* ===================== progress ===================== */

function updateProgress() {
  const progress = (currentStep / 8) * 100;
  qs("#progressFill") &&
    (qs("#progressFill").style.width = `${progress}%`);

  qsa(".step-item").forEach((item, index) => {
    item.classList.remove("active", "completed");
    if (index + 1 < currentStep) item.classList.add("completed");
    else if (index + 1 === currentStep) item.classList.add("active");
  });
}

function updateNavigationButtons() {
  const prevBtn = qs(".btn-prev");
  const nextBtn = qs(".btn-next");
  const submitBtn = qs(".btn-submit");

  if (!prevBtn || !nextBtn || !submitBtn) return;

  prevBtn.style.display = "flex";
  nextBtn.style.display = "flex";
  submitBtn.style.display = "none";

  if (currentStep === 1) {
    prevBtn.style.display = "none";
    nextBtn.style.display = "flex";
    submitBtn.style.display = "none";
  } else if (currentStep === 8) {
    prevBtn.style.display = "flex";
    nextBtn.style.display = "none";
    submitBtn.style.display = "flex";
  }
}

/* ===================== local storage ===================== */

function saveToLocalStorage() {
  localStorage.setItem("examFormData", JSON.stringify(formData));
  localStorage.setItem("examCurrentStep", currentStep);
}

function loadFromLocalStorage() {
  const savedData = localStorage.getItem("examFormData");
  const savedStep = localStorage.getItem("examCurrentStep");

  if (savedData) {
    formData = { ...formData, ...JSON.parse(savedData) };
    if (savedStep) currentStep = parseInt(savedStep);

    setHidden("#examType", formData.examType);
    setHidden("#classroomId", formData.classroomId);
    setHidden("#sectionId", formData.sectionId);
    setHidden("#gradeId", formData.gradeId);
    setHidden("#branchId", formData.branchId);
    setHidden("#fieldId", formData.fieldId);
    setHidden("#subfieldId", formData.subfieldId);
    setHidden("#subjectTypeId", formData.subjectTypeId);
    setHidden("#subjectsInput", JSON.stringify(formData.selectedSubjects));

    if (formData.examType) {
      qs(`.type-card[data-type="${formData.examType}"]`)?.classList.add(
        "selected"
      );
    }
    if (formData.examType && formData.examType !== "public") {
      showClassroomSection(true);
      loadExistingClassrooms();
    }

    updateExamTypeIndicator?.();
    updatePreview();
    updateProgress();
    updateNavigationButtons();

    qsa(".form-section").forEach((s) => s.classList.remove("active"));
    qs(`#step${currentStep}`)?.classList.add("active");
    handleStepChange();
  }
}

qs("#examForm")?.addEventListener("submit", () => {
  localStorage.removeItem("examFormData");
  localStorage.removeItem("examCurrentStep");
});

/* ===================== extras: jump + auto all subjects ===================== */

function jumpToStep(stepNumber) {
  qs(`#step${currentStep}`)?.classList.remove("active");

  currentStep = stepNumber;

  qsa(".form-section").forEach((s) => s.classList.remove("active"));
  qs(`#step${currentStep}`)?.classList.add("active");

  handleStepChange();
  updateProgress();
  updateNavigationButtons();
  updatePreview();
  saveToLocalStorage();

  window.scrollTo({ top: 0, behavior: "smooth" });
}

async function loadSubjectsForAllAndSave() {
  const params = new URLSearchParams();
  if (formData.gradeId) params.append("grade_id", formData.gradeId);
  if (formData.branchId) params.append("branch_id", formData.branchId);
  if (formData.fieldId) params.append("field_id", formData.fieldId);
  if (formData.subfieldId) params.append("subfield_id", formData.subfieldId);

  const data = await getJSON(`${endpoint.subjects}?${params.toString()}`);
  const subjects = data.subjects || [];

  formData.selectedSubjects = subjects.map((s) => s.id);
  setHidden("#subjectsInput", JSON.stringify(formData.selectedSubjects));

  const countEl = qs("#previewSubjectsCount");
  if (countEl) countEl.textContent = formData.selectedSubjects.length + " ÿØÿ±ÿ≥";

  saveToLocalStorage();
}

function updateExamTypeIndicator() {
  const wrap = qs("#examTypeIndicator");
  const text = qs("#examTypeIndicatorText");
  if (!wrap || !text) return;

  if (!formData.examType) {
    wrap.style.display = "none";
    return;
  }

  wrap.style.display = "block";
  text.textContent = examTypeNames[formData.examType] || formData.examType;

  text.className = "badge";
  if (formData.examType === "public") text.classList.add("bg-primary");
  if (formData.examType === "class_single") text.classList.add("bg-success");
  if (formData.examType === "class_comprehensive")
    text.classList.add("bg-warning");
}


==================== FILE: resources/views/dashboard/teacher/exams/index.blade.php ====================
@extends('layouts.app')
@section('title', 'ÿ¢ÿ≤ŸÖŸàŸÜ‚ÄåŸáÿß')

@push('styles')
    <style>
        /* ÿ™ŸÖ ⁄©ÿßŸÖŸÑ SmartEdu */
        :root {
            --primary: #7B68EE;
            --primary-light: rgba(123, 104, 238, 0.1);
            --primary-gradient: linear-gradient(135deg, #7B68EE, #FF6B9D);
            --secondary: #FF6B9D;
            --secondary-light: rgba(255, 107, 157, 0.1);
            --accent: #00D4AA;
            --accent-light: rgba(0, 212, 170, 0.1);
            --gold: #FFD166;
            --light: #ffffff;
            --dark: #2D3047;
            --dark-light: #3A3F6D;
            --gray: #8A8D9B;
            --light-gray: #F8F9FF;
            --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 8px 20px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 12px 30px rgba(0, 0, 0, 0.16);
            --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.2);
            --gradient-1: linear-gradient(135deg, #7B68EE, #FF6B9D);
            --gradient-2: linear-gradient(135deg, #00D4AA, #4361EE);
            --gradient-3: linear-gradient(135deg, #FFD166, #FF9A3D);
            --gradient-4: linear-gradient(135deg, #7209B7, #3A0CA3);
            --radius-xl: 24px;
            --radius-lg: 20px;
            --radius-md: 16px;
            --radius-sm: 12px;
        }

        * {
            font-family: 'Vazirmatn', sans-serif;
        }

        body {
            background-color: #f5f7ff;
            color: var(--dark);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .exams-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px 15px 80px;
            animation: fadeIn 0.6s ease both;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-30px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(30px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200% center;
            }

            100% {
                background-position: 200% center;
            }
        }

        /* ========== HEADER ========== */
        .page-header {
            background: var(--light);
            border-radius: var(--radius-xl);
            padding: 25px 30px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 30px;
            border: 2px solid rgba(123, 104, 238, 0.08);
            position: relative;
            overflow: hidden;
            animation: slideInRight 0.5s ease-out;
        }

        .page-header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, rgba(123, 104, 238, 0.05), transparent);
            border-radius: 0 var(--radius-xl) 0 0;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            position: relative;
            z-index: 2;
        }

        .header-title h1 {
            font-weight: 900;
            font-size: 1.8rem;
            color: var(--dark);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-title h1::before {
            content: '';
            width: 8px;
            height: 40px;
            background: var(--primary-gradient);
            border-radius: 10px;
        }

        .header-subtitle {
            color: var(--gray);
            font-size: 1.05rem;
            line-height: 1.8;
            max-width: 600px;
        }

        .btn-create-exam {
            padding: 15px 28px;
            border-radius: var(--radius-lg);
            font-weight: 800;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: var(--gradient-1);
            color: white;
            border: none;
            box-shadow: 0 8px 20px rgba(123, 104, 238, 0.3);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn-create-exam:active {
            transform: scale(0.97);
        }

        .btn-create-exam:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(123, 104, 238, 0.4);
        }

        .btn-create-exam::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.6s;
        }

        .btn-create-exam:hover::before {
            left: 100%;
        }

        /* ========== FILTER SECTION ========== */
        .filter-section {
            background: var(--light);
            border-radius: var(--radius-xl);
            padding: 25px 30px;
            box-shadow: var(--shadow-md);
            margin-bottom: 30px;
            border: 2px solid rgba(123, 104, 238, 0.08);
            animation: slideInLeft 0.5s ease-out;
        }

        .filter-title {
            font-weight: 900;
            font-size: 1.1rem;
            color: var(--dark);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-title i {
            color: var(--primary);
            background: var(--primary-light);
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .filter-form {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: end;
        }

        @media (max-width: 768px) {
            .filter-form {
                grid-template-columns: 1fr;
            }
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-label {
            color: var(--gray);
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 8px;
            display: block;
        }

        .form-select-custom {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--light-gray);
            border-radius: var(--radius-md);
            background: var(--light);
            color: var(--dark);
            font-weight: 700;
            transition: all 0.3s;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%237B68EE' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 18px center;
            background-size: 16px;
            padding-left: 45px;
        }

        .form-select-custom:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(123, 104, 238, 0.2);
        }

        .btn-filter {
            padding: 14px 28px;
            border-radius: var(--radius-md);
            font-weight: 800;
            font-size: 1rem;
            background: transparent;
            color: var(--dark);
            border: 2px solid var(--gray);
            transition: all 0.3s;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btn-filter:hover {
            background: var(--light-gray);
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        /* ========== EXAMS TABLE ========== */
        .exams-table-container {
            background: var(--light);
            border-radius: var(--radius-xl);
            padding: 0;
            box-shadow: var(--shadow-lg);
            border: 2px solid rgba(123, 104, 238, 0.08);
            overflow: hidden;
            animation: fadeIn 0.6s ease-out;
            animation-delay: 0.1s;
            animation-fill-mode: both;
        }

        .table-header {
            padding: 25px 30px;
            border-bottom: 2px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-weight: 900;
            font-size: 1.3rem;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0;
        }

        .table-title i {
            color: var(--primary);
            background: var(--primary-light);
            width: 45px;
            height: 45px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .exams-count {
            background: var(--primary-light);
            color: var(--primary);
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 900;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .exams-table {
            width: 100%;
            border-collapse: collapse;
        }

        .exams-table thead {
            background: linear-gradient(90deg, rgba(123, 104, 238, 0.05), rgba(255, 107, 157, 0.05));
        }

        .exams-table th {
            padding: 20px 25px;
            text-align: right;
            font-weight: 900;
            color: var(--dark);
            font-size: 0.95rem;
            border-bottom: 2px solid var(--light-gray);
            white-space: nowrap;
        }

        .exams-table tbody tr {
            transition: all 0.3s;
            border-bottom: 1px solid var(--light-gray);
        }

        .exams-table tbody tr:last-child {
            border-bottom: none;
        }

        .exams-table tbody tr:hover {
            background: var(--primary-light);
            transform: translateX(-5px);
        }

        .exams-table td {
            padding: 20px 25px;
            vertical-align: middle;
            font-weight: 700;
            color: var(--dark);
        }

        .exam-title-cell {
            font-weight: 900 !important;
            font-size: 1.05rem;
        }

        .exam-classroom {
            color: var(--gray);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .exam-duration {
            color: var(--dark);
            font-weight: 900;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .exam-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 900;
            white-space: nowrap;
        }

        .status-active {
            background: rgba(0, 212, 170, 0.15);
            color: #00D4AA;
        }

        .status-inactive {
            background: rgba(138, 141, 155, 0.15);
            color: var(--gray);
        }

        .exam-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-action {
            padding: 10px 18px;
            border-radius: var(--radius-md);
            font-weight: 800;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
            transition: all 0.3s;
            border: 2px solid transparent;
            min-width: 90px;
            justify-content: center;
        }

        .btn-action:active {
            transform: scale(0.95);
        }

        .btn-details {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-details:hover {
            background: var(--primary-light);
            transform: translateY(-3px);
            box-shadow: var(--shadow-sm);
        }

        .btn-edit {
            background: transparent;
            color: var(--dark);
            border: 2px solid var(--gray);
        }

        .btn-edit:hover {
            background: var(--light-gray);
            transform: translateY(-3px);
            box-shadow: var(--shadow-sm);
        }

        /* ========== EMPTY STATE ========== */
        .empty-state {
            padding: 60px 30px;
            text-align: center;
            animation: fadeIn 0.6s ease-out;
        }

        .empty-icon {
            font-size: 5rem;
            color: var(--light-gray);
            margin-bottom: 25px;
            opacity: 0.7;
        }

        .empty-title {
            font-weight: 900;
            font-size: 1.5rem;
            color: var(--dark);
            margin-bottom: 15px;
        }

        .empty-description {
            color: var(--gray);
            font-size: 1.1rem;
            line-height: 1.7;
            max-width: 500px;
            margin: 0 auto 30px;
        }

        /* ========== ALERTS ========== */
        .alert-success-custom {
            background: linear-gradient(135deg, rgba(0, 212, 170, 0.1), rgba(0, 212, 170, 0.05));
            border: 2px solid rgba(0, 212, 170, 0.2);
            border-radius: var(--radius-lg);
            padding: 20px 25px;
            color: var(--dark);
            font-weight: 700;
            margin-bottom: 30px;
            animation: slideInRight 0.5s ease-out;
            position: relative;
            overflow: hidden;
        }

        .alert-success-custom::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, rgba(0, 212, 170, 0.08), transparent);
            border-radius: 0 var(--radius-lg) 0 0;
        }

        .alert-success-custom i {
            color: #00D4AA;
            font-size: 1.3rem;
            margin-left: 10px;
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 992px) {
            .exams-table {
                display: block;
                overflow-x: auto;
            }

            .exams-table thead {
                display: none;
            }

            .exams-table tbody tr {
                display: block;
                margin-bottom: 20px;
                border: 2px solid var(--light-gray);
                border-radius: var(--radius-lg);
                padding: 20px;
            }

            .exams-table td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px 0;
                border-bottom: 1px dashed var(--light-gray);
            }

            .exams-table td:last-child {
                border-bottom: none;
                padding-top: 20px;
                justify-content: flex-end;
            }

            .exams-table td::before {
                content: attr(data-label);
                font-weight: 900;
                color: var(--gray);
                font-size: 0.9rem;
                min-width: 100px;
                text-align: left;
            }

            .exam-actions {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .exams-container {
                padding: 15px 10px 60px;
            }

            .page-header {
                padding: 20px;
            }

            .header-title h1 {
                font-size: 1.5rem;
            }

            .btn-create-exam {
                width: 100%;
                justify-content: center;
            }

            .filter-section {
                padding: 20px;
            }

            .table-header {
                padding: 20px;
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .empty-state {
                padding: 40px 20px;
            }

            .empty-icon {
                font-size: 4rem;
            }
        }

        @media (max-width: 480px) {
            .btn-action {
                min-width: auto;
                padding: 8px 12px;
                font-size: 0.8rem;
            }

            .exam-status {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
        }

        /* ÿØ⁄©ŸÖŸá‚ÄåŸáÿß€å ŸÑŸÖÿ≥€å ÿ®ÿ≤ÿ±⁄Ø */
        .btn-create-exam,
        .btn-filter,
        .btn-action {
            min-height: 44px;
        }

        /* ÿßŸÜÿ™ÿÆÿßÿ® ŸÖÿ™ŸÜ */
        ::selection {
            background: rgba(123, 104, 238, 0.2);
            color: var(--dark);
        }
    </style>
@endpush

@section('content')
    <div class="exams-container">
        {{-- ========== PAGE HEADER ========== --}}
        <div class="page-header">
            <div class="header-content">
                <div class="header-title">
                    <h1>
                        <span
                            style="background: linear-gradient(120deg, var(--primary) 0%, var(--secondary) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                            ÿ¢ÿ≤ŸÖŸàŸÜ‚ÄåŸáÿß€å ŸÖŸÜ
                        </span>
                        üìù
                    </h1>
                    <p class="header-subtitle">
                        ŸáŸÖŸá ÿ¢ÿ≤ŸÖŸàŸÜ‚ÄåŸáÿß€å ⁄©ŸÑÿßÿ≥‚ÄåŸáÿß€å ÿ¥ŸÖÿß ÿØÿ± €å⁄© ŸÜ⁄ØÿßŸá.
                        ŸÖ€å‚Äåÿ™ŸàÿßŸÜ€åÿØ ÿ¢ÿ≤ŸÖŸàŸÜ‚ÄåŸáÿß ÿ±ÿß ŸÖÿØ€åÿ±€åÿ™ÿå Ÿà€åÿ±ÿß€åÿ¥ Ÿà ŸÜÿ™ÿß€åÿ¨ ÿ±ÿß ŸÖÿ¥ÿßŸáÿØŸá ⁄©ŸÜ€åÿØ.
                    </p>
                </div>

                <a href="{{ route('teacher.exams.create') }}" class="btn-create-exam">
                    <i class="fas fa-plus-circle"></i>
                    ÿ≥ÿßÿÆÿ™ ÿ¢ÿ≤ŸÖŸàŸÜ ÿ¨ÿØ€åÿØ
                </a>
            </div>
        </div>

        {{-- ========== SUCCESS ALERT ========== --}}
        @if (session('success'))
            <div class="alert-success-custom d-flex align-items-center">
                <i class="fas fa-check-circle"></i>
                <div class="flex-grow-1">{{ session('success') }}</div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        @endif

        {{-- ========== FILTER SECTION ========== --}}
        <div class="filter-section">
            <h3 class="filter-title">
                <i class="fas fa-filter"></i>
                ŸÅ€åŸÑÿ™ÿ± Ÿà ÿ¨ÿ≥ÿ™ÿ¨Ÿà€å Ÿæ€åÿ¥ÿ±ŸÅÿ™Ÿá
            </h3>

            <form method="GET" class="filter-form">
                <div class="form-group">
                    <label class="form-label">ŸÅ€åŸÑÿ™ÿ± ÿ®ÿ± ÿßÿ≥ÿßÿ≥ ⁄©ŸÑÿßÿ≥</label>
                    <select name="classroom_id" class="form-select-custom">
                        <option value="">ŸáŸÖŸá ⁄©ŸÑÿßÿ≥‚ÄåŸáÿß</option>
@foreach (($classrooms ?? []) as $c)
                            <option value="{{ $c->id }}" @selected(request('classroom_id') == $c->id)>
                                {{ $c->title ?? $c->name }}
                            </option>
                        @endforeach
                    </select>
                </div>

                <button type="submit" class="btn-filter">
                    <i class="fas fa-sliders-h"></i>
                    ÿßÿπŸÖÿßŸÑ ŸÅ€åŸÑÿ™ÿ±
                </button>
            </form>
        </div>

        {{-- ========== EXAMS TABLE ========== --}}
        @if ($exams->count() === 0)
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-clipboard-list"></i>
                </div>
                <h3 class="empty-title">ŸáŸÜŸàÿ≤ ÿ¢ÿ≤ŸÖŸàŸÜ€å ŸÜÿ≥ÿßÿÆÿ™Ÿá‚Äåÿß€åÿØ!</h3>
                <p class="empty-description">
                    ÿ®ÿ±ÿß€å ÿ¥ÿ±Ÿàÿπÿå ÿßŸàŸÑ€åŸÜ ÿ¢ÿ≤ŸÖŸàŸÜ ÿÆŸàÿØ ÿ±ÿß ÿß€åÿ¨ÿßÿØ ⁄©ŸÜ€åÿØ.
                    ŸÖ€å‚Äåÿ™ŸàÿßŸÜ€åÿØ ÿßŸÜŸàÿßÿπ ŸÖÿÆÿ™ŸÑŸÅ€å ÿßÿ≤ ÿ¢ÿ≤ŸÖŸàŸÜ‚ÄåŸáÿß ÿ¥ÿßŸÖŸÑ ÿ™ÿ≥ÿ™€åÿå ÿ™ÿ¥ÿ±€åÿ≠€å Ÿà ÿ™ÿ±⁄©€åÿ®€å ÿ®ÿ≥ÿßÿ≤€åÿØ.
                </p>
                <a href="{{ route('teacher.exams.create') }}" class="btn-create-exam">
                    <i class="fas fa-plus-circle"></i>
                    ÿß€åÿ¨ÿßÿØ ÿßŸàŸÑ€åŸÜ ÿ¢ÿ≤ŸÖŸàŸÜ
                </a>
            </div>
        @else
            <div class="exams-table-container">
                <div class="table-header">
                    <h3 class="table-title">
                        <i class="fas fa-list-check"></i>
                        ŸÑ€åÿ≥ÿ™ ÿ¢ÿ≤ŸÖŸàŸÜ‚ÄåŸáÿß
                    </h3>
                    <div class="exams-count">
                        <i class="fas fa-hashtag"></i>
                        {{ $exams->count() }} ÿ¢ÿ≤ŸÖŸàŸÜ
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="exams-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>ÿπŸÜŸàÿßŸÜ ÿ¢ÿ≤ŸÖŸàŸÜ</th>
                                <th>⁄©ŸÑÿßÿ≥</th>
                                <th>ŸÖÿØÿ™ ÿ≤ŸÖÿßŸÜ</th>
                                <th>Ÿàÿ∂ÿπ€åÿ™</th>
                                <th>ÿπŸÖŸÑ€åÿßÿ™</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach ($exams as $exam)
                                <tr>
                                    <td data-label="ÿ¥ŸÖÿßÿ±Ÿá">
                                        <span style="color: var(--primary); font-weight: 900; font-size: 1.1rem;">
                                            {{ $loop->iteration }}
                                        </span>
                                    </td>
                                    <td data-label="ÿπŸÜŸàÿßŸÜ ÿ¢ÿ≤ŸÖŸàŸÜ" class="exam-title-cell">
                                        {{ $exam->title }}
                                    </td>
                                    <td data-label="⁄©ŸÑÿßÿ≥">
                                        <div class="exam-classroom">
                                            <i class="fas fa-people-group"></i>
                                            {{ $exam->classroom->title ?? ($exam->classroom->name ?? '‚Äî') }}
                                        </div>
                                    </td>
                                    <td data-label="ŸÖÿØÿ™ ÿ≤ŸÖÿßŸÜ">
                                        <div class="exam-duration">
                                            <i class="fas fa-clock"></i>
                                            {{ $exam->duration ?? ($exam->duration_minutes ?? '‚Äî') }} ÿØŸÇ€åŸÇŸá
                                        </div>
                                    </td>
                                    <td data-label="Ÿàÿ∂ÿπ€åÿ™">
                                        @if ($exam->is_active)
                                            <span class="exam-status status-active">
                                                <i class="fas fa-check-circle"></i>
                                                ŸÅÿπÿßŸÑ
                                            </span>
                                        @else
                                            <span class="exam-status status-inactive">
                                                <i class="fas fa-pause-circle"></i>
                                                ÿ∫€åÿ±ŸÅÿπÿßŸÑ
                                            </span>
                                        @endif
                                    </td>
                                    <td data-label="ÿπŸÖŸÑ€åÿßÿ™">
                                        <div class="exam-actions">
                                            <a href="{{ route('teacher.exams.show', $exam) }}"
                                                class="btn-action btn-details">
                                                <i class="fas fa-eye"></i>
                                                ÿ¨ÿ≤ÿ¶€åÿßÿ™
                                            </a>
                                            <a href="{{ route('teacher.exams.edit', $exam) }}" class="btn-action btn-edit">
                                                <i class="fas fa-edit"></i>
                                                Ÿà€åÿ±ÿß€åÿ¥
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            @endforeach
                        </tbody>
                    </table>
                </div>
            </div>
        @endif
    </div>
@endsection

@push('scripts')
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Ÿà€åÿ®ÿ±Ÿá ÿ®ÿ±ÿß€å ŸÖŸàÿ®ÿß€åŸÑ
            if (navigator.vibrate) {
                const clickableItems = document.querySelectorAll(
                    '.btn-create-exam, .btn-filter, .btn-action, .exams-table tbody tr');
                clickableItems.forEach(item => {
                    item.addEventListener('click', function() {
                        navigator.vibrate(20);
                    });
                });
            }

            // ÿßŸÅ⁄©ÿ™ hover ÿ®ÿ±ÿß€å ÿ≥ÿ∑ÿ±Ÿáÿß€å ÿ¨ÿØŸàŸÑ
            const tableRows = document.querySelectorAll('.exams-table tbody tr');
            tableRows.forEach(row => {
                row.addEventListener('mouseenter', function() {
                    if (navigator.vibrate) {
                        navigator.vibrate(10);
                    }
                });

                // ⁄©ŸÑ€å⁄© ÿ±Ÿà€å ÿ≥ÿ∑ÿ± ÿ®ÿ±ÿß€å ŸÖÿ¥ÿßŸáÿØŸá ÿ¨ÿ≤ÿ¶€åÿßÿ™
                const detailsBtn = row.querySelector('.btn-details');
                if (detailsBtn) {
                    row.addEventListener('click', function(e) {
                        if (!e.target.closest('.btn-action')) {
                            window.location.href = detailsBtn.href;
                        }
                    });
                }
            });

            // ÿßŸÜ€åŸÖ€åÿ¥ŸÜ Ÿàÿ±ŸàÿØ ÿßŸÑŸÖÿßŸÜ‚ÄåŸáÿß
            const animateElements = () => {
                const elements = document.querySelectorAll('.exams-table tbody tr');
                elements.forEach((el, i) => {
                    el.style.animationDelay = `${i * 0.05}s`;
                    el.style.animation = 'fadeIn 0.5s ease-out forwards';
                    el.style.opacity = '0';
                });
            };

            // ÿßÿ¨ÿ±ÿß€å ÿßŸÜ€åŸÖ€åÿ¥ŸÜ ÿ®ÿπÿØ ÿßÿ≤ ŸÑŸàÿØ ÿµŸÅÿ≠Ÿá
            setTimeout(animateElements, 300);

            // ÿßÿπÿ™ÿ®ÿßÿ±ÿ≥ŸÜÿ¨€å ŸÅ€åŸÑÿ™ÿ±
            const filterForm = document.querySelector('.filter-form');
            if (filterForm) {
                filterForm.addEventListener('submit', function(e) {
                    const select = this.querySelector('select[name="classroom_id"]');
                    if (select.value) {
                        // ŸÜŸÖÿß€åÿ¥ ÿ®ÿßÿ±⁄Ø€åÿ±€å
                        const submitBtn = this.querySelector('button[type="submit"]');
                        const originalText = submitBtn.innerHTML;
                        submitBtn.innerHTML =
                            '<i class="fas fa-spinner fa-spin"></i> ÿØÿ± ÿ≠ÿßŸÑ ÿßÿπŸÖÿßŸÑ ŸÅ€åŸÑÿ™ÿ±...';
                        submitBtn.disabled = true;

                        setTimeout(() => {
                            submitBtn.innerHTML = originalText;
                            submitBtn.disabled = false;
                        }, 1000);
                    }
                });
            }

            // ŸÜŸÖÿß€åÿ¥ ÿ™ÿπÿØÿßÿØ ⁄©ŸÑÿßÿ≥‚ÄåŸáÿß€å ŸÅ€åŸÑÿ™ÿ± ÿ¥ÿØŸá
            const updateFilterCount = () => {
                const selectedClass = document.querySelector('select[name="classroom_id"]').value;
                const examCount = document.querySelectorAll('.exams-table tbody tr').length;
                const countElement = document.querySelector('.exams-count');

                if (countElement && selectedClass) {
                    const className = document.querySelector(`option[value="${selectedClass}"]`).textContent;
                    countElement.innerHTML = `<i class="fas fa-filter"></i> ${examCount} ÿ¢ÿ≤ŸÖŸàŸÜ (${className})`;
                }
            };

            // ÿ±Ÿà€åÿØÿßÿØ ÿ™ÿ∫€å€åÿ± ŸÅ€åŸÑÿ™ÿ±
            const classSelect = document.querySelector('select[name="classroom_id"]');
            if (classSelect) {
                classSelect.addEventListener('change', updateFilterCount);
            }
        });

        // ÿßÿ∂ÿßŸÅŸá ⁄©ÿ±ÿØŸÜ ÿßÿ≥ÿ™ÿß€åŸÑ‚ÄåŸáÿß€å ÿßŸÜ€åŸÖ€åÿ¥ŸÜ
        const style = document.createElement('style');
        style.textContent = `
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
`;
        document.head.appendChild(style);
    </script>
@endpush


==================== FILE: resources/views/dashboard/teacher/exams/show.blade.php ====================
@extends('layouts.app')
@section('title', 'ÿ¨ÿ≤ÿ¶€åÿßÿ™ ÿ¢ÿ≤ŸÖŸàŸÜ')

@push('styles')
    <style>
        .card-soft {
            border: 0;
            border-radius: 1.25rem;
            box-shadow: 0 8px 24px rgba(18, 38, 63, .06);
            background: #fff;
        }

        .chip {
            background: #eef2ff;
            padding: .25rem .6rem;
            border-radius: 999px;
            font-weight: 700;
        }

        .tiny {
            font-size: .85rem;
        }

        .muted {
            color: #6b7280;
        }

        .hero {
            position: relative;
            overflow: hidden;
            border-radius: 1.5rem;
            background: linear-gradient(135deg, #0d6efd10, #20c99710);
            border: 1px dashed #e5e7eb;
        }

        .hero-orb {
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            right: -70px;
            top: -70px;
            background: radial-gradient(circle, #0d6efd22, transparent 60%);
        }

        .hero-orb2 {
            position: absolute;
            width: 160px;
            height: 160px;
            border-radius: 50%;
            left: -50px;
            bottom: -50px;
            background: radial-gradient(circle, #20c99722, transparent 60%);
        }

        .q-row:hover {
            background: #f9fafb;
        }
    </style>
@endpush

@section('content')
    <div class="container py-4">

        {{-- Hero --}}
        <div class="hero card-soft p-3 p-md-4 mb-4">
            <div class="hero-orb"></div>
            <div class="hero-orb2"></div>

            <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
                <div>
                    <h4 class="fw-bold mb-1">
                        <i class="bi bi-clipboard-check me-1 text-primary"></i>
                        {{ $exam->title }}
                    </h4>

                    <div class="text-muted small">
                        ⁄©ŸÑÿßÿ≥:
                        @if ($exam->classroom)
                            <span class="chip">{{ $exam->classroom->title ?? $exam->classroom->name }}</span>
                        @else
                            <span class="text-warning">ŸÜÿßŸÖÿ¥ÿÆÿµ</span>
                        @endif

                        <span class="mx-1">‚Ä¢</span>

                        ŸÖÿØÿ™: {{ $exam->duration_minutes ?? ($exam->duration ?? '‚Äî') }} ÿØŸÇ€åŸÇŸá

                        <span class="mx-1">‚Ä¢</span>

                        Ÿàÿ∂ÿπ€åÿ™:
                        @if ($exam->is_published)
                            <span class="badge bg-success">ŸÖŸÜÿ™ÿ¥ÿ± ÿ¥ÿØŸá</span>
                        @else
                            <span class="badge bg-secondary">Ÿæ€åÿ¥‚ÄåŸÜŸà€åÿ≥</span>
                        @endif
                    </div>

                    @if (!empty($exam->description))
                        <div class="tiny muted mt-2">
                            {{ $exam->description }}
                        </div>
                    @endif
                </div>

                <div class="d-flex gap-2 flex-wrap">
                    <a href="{{ route('teacher.exams.edit', $exam) }}"
                        class="btn btn-outline-warning d-inline-flex align-items-center gap-2 shadow-sm">
                        <i class="bi bi-pencil-square"></i>
                        Ÿà€åÿ±ÿß€åÿ¥ ÿ¢ÿ≤ŸÖŸàŸÜ
                    </a>

                    <a href="{{ route('teacher.exams.questions.index', $exam) }}"
                        class="btn btn-primary d-inline-flex align-items-center gap-2 shadow-sm">
                        <i class="bi bi-question-circle"></i>
                        ŸÖÿØ€åÿ±€åÿ™ ÿ≥ŸàÿßŸÑ‚ÄåŸáÿß
                    </a>

                    <a href="{{ route('teacher.exams.index') }}"
                        class="btn btn-outline-secondary d-inline-flex align-items-center gap-2 shadow-sm">
                        <i class="bi bi-arrow-right"></i>
                        ÿ®ÿßÿ≤⁄Øÿ¥ÿ™
                    </a>
                </div>
            </div>
        </div>

        @if (session('success'))
            <div class="alert alert-success">{{ session('success') }}</div>
        @endif

        @php
            $questions = $exam->questions ?? collect();
            $totalScore = $questions->sum('score');
        @endphp

        {{-- Summary --}}
        <div class="row g-3 mb-3">
            <div class="col-md-4">
                <div class="card card-soft">
                    <div class="card-body">
                        <div class="text-muted small">ÿ™ÿπÿØÿßÿØ ÿ≥ŸàÿßŸÑ‚ÄåŸáÿß</div>
                        <div class="fs-4 fw-bold">{{ $questions->count() }}</div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card card-soft">
                    <div class="card-body">
                        <div class="text-muted small">ŸÖÿ¨ŸÖŸàÿπ ÿßŸÖÿ™€åÿßÿ≤</div>
                        <div class="fs-4 fw-bold">{{ $totalScore }}</div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card card-soft">
                    <div class="card-body">
                        <div class="text-muted small">ÿ¥ŸÜÿßÿ≥Ÿá ÿ¢ÿ≤ŸÖŸàŸÜ</div>
                        <div class="fs-5 fw-bold">#{{ $exam->id }}</div>
                    </div>
                </div>
            </div>
        </div>

        {{-- Questions Preview --}}
        <div class="card card-soft">
            <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                <span>
                    <i class="bi bi-list-check me-1 text-primary"></i>
                    ÿ≥ŸàÿßŸÑ‚ÄåŸáÿß€å ÿ¢ÿ≤ŸÖŸàŸÜ
                </span>

                <a href="{{ route('teacher.exams.questions.create', $exam) }}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-plus"></i> ÿßŸÅÿ≤ŸàÿØŸÜ ÿ≥ŸàÿßŸÑ
                </a>
            </div>

            <div class="table-responsive">
                <table class="table align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>ŸÖÿ™ŸÜ ÿ≥ŸàÿßŸÑ</th>
                            <th>ŸÜŸàÿπ</th>
                            <th>ÿßŸÖÿ™€åÿßÿ≤</th>
                            <th>Ÿæÿßÿ≥ÿÆ ÿµÿ≠€åÿ≠</th>
                        </tr>
                    </thead>
                    <tbody>
                        @forelse($questions as $q)
                            @php
                                $type = $q->question_type;
                                $correct = null;

                                if ($type === 'mcq') {
                                    $correct = is_array($q->correct_answer)
                                        ? strtoupper($q->correct_answer['correct_option'] ?? '')
                                        : '‚Äî';
                                } elseif ($type === 'true_false') {
                                    $val = is_array($q->correct_answer)
                                        ? ($q->correct_answer['value'] ?? null)
                                        : null;
                                    $correct = ($val === true || $val === 1 || $val === '1') ? 'True' : 'False';
                                } elseif ($type === 'fill_blank') {
                                    $correct = is_array($q->correct_answer)
                                        ? implode(' , ', $q->correct_answer)
                                        : ($q->correct_answer ?? '‚Äî');
                                } else {
                                    $correct = '‚Äî (ÿ™ÿ¥ÿ±€åÿ≠€å)';
                                }
                            @endphp

                            <tr class="q-row">
                                <td class="fw-semibold">{{ $loop->iteration }}</td>
                                <td style="max-width:520px">
                                    {{ \Illuminate\Support\Str::limit($q->content, 140) }}
                                </td>
                                <td>
                                    <span class="badge bg-light text-dark border rounded-pill">
                                        {{ str_replace('_', ' ', $q->question_type) }}
                                    </span>
                                </td>
                                <td class="fw-bold">{{ $q->score }}</td>
                                <td class="tiny muted">{{ $correct }}</td>
                            </tr>
                        @empty
                            <tr>
                                <td colspan="5" class="text-center text-muted py-5">
                                    ŸáŸÜŸàÿ≤ Ÿá€å⁄Ü ÿ≥ŸàÿßŸÑ€å ÿ®ÿ±ÿß€å ÿß€åŸÜ ÿ¢ÿ≤ŸÖŸàŸÜ ÿ´ÿ®ÿ™ ŸÜÿ¥ÿØŸá ÿßÿ≥ÿ™.
                                    <div class="mt-3">
                                        <a href="{{ route('teacher.exams.questions.create', $exam) }}"
                                            class="btn btn-primary">
                                            <i class="bi bi-plus-circle"></i>
                                            ÿßŸàŸÑ€åŸÜ ÿ≥ŸàÿßŸÑ ÿ±ÿß ÿ®ÿ≥ÿßÿ≤
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        @endforelse
                    </tbody>
                </table>
            </div>
        </div>

    </div>
@endsection


